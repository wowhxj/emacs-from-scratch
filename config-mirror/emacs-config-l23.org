#+TITLE: Emacsé…ç½®æ–‡ä»¶
#+SUBTITLE: é¢å‘äº§å“ç»ç†çš„Emacsæ•™ç¨‹
#+AUTHOR: Randolph
#+DATE: 2022/12/22 14:23:50

#+STARTUP: overview
#+SETUPFILE: ~/.emacs.d.default/org-setupfile.org
#+OPTIONS: author:nil date:nil email:nil timestamp:nil num:t

* ç›®å½•                                                                  :toc:
- [[#early-initel][early-init.el]]
- [[#initel][init.el]]
  - [[#initel-æ–‡ä»¶å¤´][init.el æ–‡ä»¶å¤´]]
  - [[#packageåŒ…ç®¡ç†é…ç½®][packageåŒ…ç®¡ç†é…ç½®]]
  - [[#å®‰è£…use-packageæ’ä»¶][å®‰è£…use-packageæ’ä»¶]]
  - [[#quelpaåŒ…ç®¡ç†å™¨][quelpaåŒ…ç®¡ç†å™¨]]
  - [[#åŠ è½½æ¨¡å—åŒ–é…ç½®][åŠ è½½æ¨¡å—åŒ–é…ç½®]]
  - [[#initel-æ–‡ä»¶å°¾][init.el æ–‡ä»¶å°¾]]
- [[#init-uiel][init-ui.el]]
  - [[#init-uiel-æ–‡ä»¶å¤´][init-ui.el æ–‡ä»¶å¤´]]
  - [[#efä¸»é¢˜][efä¸»é¢˜]]
  - [[#å­—ä½“è®¾ç½®][å­—ä½“è®¾ç½®]]
  - [[#çª—å£è®¾ç½®][çª—å£è®¾ç½®]]
  - [[#å…¶ä»–uié›¶æ•£è®¾ç½®é¡¹][å…¶ä»–UIé›¶æ•£è®¾ç½®é¡¹]]
  - [[#ç¼–ç è®¾ç½®][ç¼–ç è®¾ç½®]]
  - [[#æ¨¡å¼æ è®¾ç½®][æ¨¡å¼æ è®¾ç½®]]
  - [[#notificationsé€šçŸ¥ç®¡ç†][notificationsé€šçŸ¥ç®¡ç†]]
  - [[#å›¾æ ‡è®¾ç½®][å›¾æ ‡è®¾ç½®]]
  - [[#init-uiel-æ–‡ä»¶å°¾][init-ui.el æ–‡ä»¶å°¾]]
- [[#init-baseel][init-base.el]]
  - [[#init-baseel-æ–‡ä»¶å¤´][init-base.el æ–‡ä»¶å¤´]]
  - [[#no-litteringè®©é…ç½®ç›®å½•ç®€æ´][no-litteringè®©é…ç½®ç›®å½•ç®€æ´]]
  - [[#savehistè®°ä½è¿·ä½ ç¼“å†²åŒºå†å²][savehistè®°ä½è¿·ä½ ç¼“å†²åŒºå†å²]]
  - [[#saveplaceè®°ä½æ¯ä¸ªæ–‡ä»¶çš„å…‰æ ‡ä½ç½®][saveplaceè®°ä½æ¯ä¸ªæ–‡ä»¶çš„å…‰æ ‡ä½ç½®]]
  - [[#recentfæœ€è¿‘æ‰“å¼€çš„æ–‡ä»¶å†å²][recentfæœ€è¿‘æ‰“å¼€çš„æ–‡ä»¶å†å²]]
  - [[#undo-treeæ’¤é”€è®¾ç½®][undo-treeæ’¤é”€è®¾ç½®]]
  - [[#super-saveè‡ªåŠ¨ä¿å­˜][super-saveè‡ªåŠ¨ä¿å­˜]]
  - [[#cruxç³»ç»Ÿå¢å¼º][cruxç³»ç»Ÿå¢å¼º]]
  - [[#ä¸ªäººå‡½æ•°å®šä¹‰][ä¸ªäººå‡½æ•°å®šä¹‰]]
  - [[#åˆ«åå®šä¹‰][åˆ«åå®šä¹‰]]
  - [[#init-baseel-æ–‡ä»¶å°¾][init-base.el æ–‡ä»¶å°¾]]
- [[#init-editel][init-edit.el]]
  - [[#init-editel-æ–‡ä»¶å¤´][init-edit.el æ–‡ä»¶å¤´]]
  - [[#emacså¤‡ä»½è®¾ç½®][Emacså¤‡ä»½è®¾ç½®]]
  - [[#è§£é™¤ä¸€äº›ä¸å¸¸ç”¨çš„å¿«æ·é”®][è§£é™¤ä¸€äº›ä¸å¸¸ç”¨çš„å¿«æ·é”®]]
  - [[#delselé€‰æ‹©æ–‡æœ¬è¾“å…¥æ—¶ç›´æ¥æ›¿æ¢][delselé€‰æ‹©æ–‡æœ¬è¾“å…¥æ—¶ç›´æ¥æ›¿æ¢]]
  - [[#è‡ªåŠ¨é‡è½½è®¾ç½®][è‡ªåŠ¨é‡è½½è®¾ç½®]]
  - [[#avyå…‰æ ‡ç§»åŠ¨][avyå…‰æ ‡ç§»åŠ¨]]
  - [[#multiple-cursorså¤šå…‰æ ‡ç¼–è¾‘][multiple-cursorså¤šå…‰æ ‡ç¼–è¾‘]]
  - [[#init-editel-æ–‡ä»¶å°¾][init-edit.el æ–‡ä»¶å°¾]]
- [[#init-orgel][init-org.el]]
  - [[#init-orgel-æ–‡ä»¶å¤´][init-org.el æ–‡ä»¶å¤´]]
  - [[#org-modeåŸºæœ¬é…ç½®][Org modeåŸºæœ¬é…ç½®]]
  - [[#org-modern-ç¾åŒ–][org-modern ç¾åŒ–]]
  - [[#org-appearè‡ªåŠ¨å±•å¼€å¼ºè°ƒé“¾æ¥][org-appearè‡ªåŠ¨å±•å¼€å¼ºè°ƒé“¾æ¥]]
  - [[#org-auto-tangleè‡ªåŠ¨tangleè®¾ç½®][org-auto-tangleè‡ªåŠ¨tangleè®¾ç½®]]
  - [[#org-captureå¿«é€Ÿè®°å½•è®¾ç½®][org-captureå¿«é€Ÿè®°å½•è®¾ç½®]]
  - [[#denoteç¬”è®°è®¾ç½®][denoteç¬”è®°è®¾ç½®]]
  - [[#consult-notesæŸ¥æ‰¾ç¬”è®°][consult-notesæŸ¥æ‰¾ç¬”è®°]]
  - [[#org-super-linksåé“¾è®¾ç½®][org-super-linksåé“¾è®¾ç½®]]
  - [[#org-srcä»£ç å—åŸºç¡€é…ç½®][org-srcä»£ç å—åŸºç¡€é…ç½®]]
  - [[#org-babelä»£ç å—åç«¯][org babelä»£ç å—åç«¯]]
  - [[#é™åˆ¶ä»£ç å—ç»“æœé•¿åº¦][é™åˆ¶ä»£ç å—ç»“æœé•¿åº¦]]
  - [[#oxæ–‡ä»¶å¯¼å‡ºé€šç”¨è®¾ç½®][oxæ–‡ä»¶å¯¼å‡ºé€šç”¨è®¾ç½®]]
  - [[#orgå¯¼å‡ºåç«¯è®¾ç½®][orgå¯¼å‡ºåç«¯è®¾ç½®]]
  - [[#å›¾ç‰‡ç²˜è´´][å›¾ç‰‡ç²˜è´´]]
  - [[#toc-orgç›®å½•è‡ªåŠ¨ç”Ÿæˆ][toc-orgç›®å½•è‡ªåŠ¨ç”Ÿæˆ]]
  - [[#olæ–°å¢é“¾æ¥ç±»å‹][olæ–°å¢é“¾æ¥ç±»å‹]]
  - [[#org-mode-ä»»åŠ¡ç®¡ç†][Org mode ä»»åŠ¡ç®¡ç†]]
  - [[#init-orgel-æ–‡ä»¶å°¾][init-org.el æ–‡ä»¶å°¾]]
- [[#init-completionel][init-completion.el]]
  - [[#init-completionel-æ–‡ä»¶å¤´][init-completion.el æ–‡ä»¶å¤´]]
  - [[#vertico][vertico]]
  - [[#orderless][orderless]]
  - [[#marginalia][marginalia]]
  - [[#consult][consult]]
  - [[#corfu][corfu]]
  - [[#yasnippetæ¨¡æ¿è¡¥å…¨][yasnippetæ¨¡æ¿è¡¥å…¨]]
  - [[#all-the-icons-completionè¡¥å…¨å›¾æ ‡ç¾åŒ–][all-the-icons-completionè¡¥å…¨å›¾æ ‡ç¾åŒ–]]
  - [[#embark][embark]]
  - [[#init-completionel-æ–‡ä»¶å°¾][init-completion.el æ–‡ä»¶å°¾]]
- [[#init-diredel][init-dired.el]]
  - [[#init-diredel-æ–‡ä»¶å¤´][init-dired.el æ–‡ä»¶å¤´]]
  - [[#diredåŸºç¡€é…ç½®][DiredåŸºç¡€é…ç½®]]
  - [[#diredflå¤šå½©ç¾åŒ–][diredflå¤šå½©ç¾åŒ–]]
  - [[#all-the-icons-diredå›¾æ ‡ç¾åŒ–][all-the-icons-diredå›¾æ ‡ç¾åŒ–]]
  - [[#dirvishæ–‡ä»¶ç®¡ç†][dirvishæ–‡ä»¶ç®¡ç†]]
  - [[#init-diredel-æ–‡ä»¶å°¾][init-dired.el æ–‡ä»¶å°¾]]
- [[#init-toolsel][init-tools.el]]
  - [[#init-toolsel-æ–‡ä»¶å¤´][init-tools.el æ–‡ä»¶å¤´]]
  - [[#helpfulå¸®åŠ©å¢å¼º][helpfulå¸®åŠ©å¢å¼º]]
  - [[#which-keyå¿«æ·é”®][which-keyå¿«æ·é”®]]
  - [[#init-toolsel-æ–‡ä»¶å°¾][init-tools.el æ–‡ä»¶å°¾]]
- [[#init-devel][init-dev.el]]
  - [[#init-devel-æ–‡ä»¶å¤´][init-dev.el æ–‡ä»¶å¤´]]
  - [[#vcè®¾ç½®][vcè®¾ç½®]]
  - [[#magitç‰ˆæœ¬ç®¡ç†][magitç‰ˆæœ¬ç®¡ç†]]
  - [[#diff-hlé«˜äº®æ˜¾ç¤ºä¿®æ”¹çš„éƒ¨åˆ†][diff-hlé«˜äº®æ˜¾ç¤ºä¿®æ”¹çš„éƒ¨åˆ†]]
  - [[#magit-deltaå¢å¼ºgit-diff][magit-deltaå¢å¼ºgit diff]]
  - [[#parené«˜äº®åŒ¹é…çš„æ‹¬å·][parené«˜äº®åŒ¹é…çš„æ‹¬å·]]
  - [[#rainbow-delimeterså¤šå½©æ‹¬å·][rainbow-delimeterså¤šå½©æ‹¬å·]]
  - [[#emacs-lispè¯­è¨€è®¾ç½®][emacs-lispè¯­è¨€è®¾ç½®]]
  - [[#pythonè¯­è¨€è®¾ç½®][Pythonè¯­è¨€è®¾ç½®]]
  - [[#shellè¯­è¨€è®¾ç½®][Shellè¯­è¨€è®¾ç½®]]
  - [[#init-devel-æ–‡ä»¶å°¾][init-dev.el æ–‡ä»¶å°¾]]
- [[#init-mailel][init-mail.el]]
  - [[#init-mailel-æ–‡ä»¶å¤´][init-mail.el æ–‡ä»¶å¤´]]
  - [[#notmuché‚®ä»¶ç³»ç»Ÿ][notmuché‚®ä»¶ç³»ç»Ÿ]]
  - [[#é‚®ä»¶å‘é€é…ç½®][é‚®ä»¶å‘é€é…ç½®]]
  - [[#é‚®ä»¶ç³»ç»Ÿé€šçŸ¥][é‚®ä»¶ç³»ç»Ÿé€šçŸ¥]]
  - [[#init-mailel-æ–‡ä»¶å°¾][init-mail.el æ–‡ä»¶å°¾]]
- [[#init-rssel][init-rss.el]]
  - [[#init-rssel-æ–‡ä»¶å¤´][init-rss.el æ–‡ä»¶å¤´]]
  - [[#elfeed][elfeed]]
  - [[#elfeed-goodiesç»™elfeedä¼˜åŒ–å¢å¼º][elfeed-goodiesç»™elfeedä¼˜åŒ–å¢å¼º]]
  - [[#init-rssel-æ–‡ä»¶å°¾][init-rss.el æ–‡ä»¶å°¾]]
- [[#init-shellel][init-shell.el]]
  - [[#init-shellel-æ–‡ä»¶å¤´][init-shell.el æ–‡ä»¶å¤´]]
  - [[#eshell-åŸºæœ¬é…ç½®][eshell åŸºæœ¬é…ç½®]]
  - [[#eshell-alias-è®¾ç½®][eshell alias è®¾ç½®]]
  - [[#eshell-é‡Œçš„-c-d][eshell é‡Œçš„ C-d]]
  - [[#eshell-çš„å‘½ä»¤å†å²][Eshell çš„å‘½ä»¤å†å²]]
  - [[#æœ‰äº›å‘½ä»¤ä½¿ç”¨-term][æœ‰äº›å‘½ä»¤ä½¿ç”¨ term]]
  - [[#eshell-git-prompt-å‘½ä»¤è¡Œä¸»é¢˜][eshell-git-prompt å‘½ä»¤è¡Œä¸»é¢˜]]
  - [[#eshell-syntax-highlighting-è¯­æ³•é«˜äº®][eshell-syntax-highlighting è¯­æ³•é«˜äº®]]
  - [[#esh-autosuggestè‡ªåŠ¨è¡¥å…¨][esh-autosuggestè‡ªåŠ¨è¡¥å…¨]]
  - [[#eshell-upå¿«é€Ÿè¿›å…¥çˆ¶çº§æ–‡ä»¶å¤¹][eshell-upå¿«é€Ÿè¿›å…¥çˆ¶çº§æ–‡ä»¶å¤¹]]
  - [[#init-shellel-æ–‡ä»¶å°¾][init-shell.el æ–‡ä»¶å°¾]]

* early-init.el
:PROPERTIES:
:HEADER-ARGS: :tangle early-init.el
:END:

åœ¨Emacsåˆšå¯åŠ¨ï¼Œè¿˜æœªåŠ è½½ä¸»è¦é…ç½®æ–‡ä»¶æ—¶çš„é…ç½®æ–‡ä»¶ã€‚

#+BEGIN_SRC emacs-lisp
;;; early-init.el --- Emacs pre-initialization config -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

;; è®¾ç½®åƒåœ¾å›æ”¶å‚æ•°
(setq gc-cons-threshold most-positive-fixnum)
(setq gc-cons-percentage 0.6)

;; å¯åŠ¨æ—©æœŸä¸åŠ è½½`package.el'åŒ…ç®¡ç†å™¨
(setq package-enable-at-startup nil)
;; ä¸ä»åŒ…ç¼“å­˜ä¸­åŠ è½½
(setq package-quickstart nil)

;; ç¦æ­¢å±•ç¤ºèœå•æ ã€å·¥å…·æ å’Œçºµå‘æ»šåŠ¨æ¡
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)

;; ç¦æ­¢è‡ªåŠ¨ç¼©æ”¾çª—å£å…ˆ
(setq frame-inhibit-implied-resize t)

;; ç¦æ­¢èœå•æ ã€å·¥å…·æ ã€æ»šåŠ¨æ¡æ¨¡å¼ï¼Œç¦æ­¢å¯åŠ¨å±å¹•å’Œæ–‡ä»¶å¯¹è¯æ¡†
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)
(setq inhibit-splash-screen t)
(setq use-file-dialog nil)

;; åœ¨è¿™ä¸ªé˜¶æ®µä¸ç¼–è¯‘
(setq comp-deferred-compilation nil)

(provide 'early-init)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; early-init.el ends here
#+END_SRC

* init.el
:PROPERTIES:
:HEADER-ARGS: :tangle init.el
:END:

=init.el= æ˜¯Emacsçš„ä¸»è¦é…ç½®æ–‡ä»¶ã€‚

** init.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init.el --- The main init entry for Emacs -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** packageåŒ…ç®¡ç†é…ç½®
#+begin_src emacs-lisp
(require 'package)
(setq package-archives
	  '(("melpa"  . "https://melpa.org/packages/")
	    ("gnu"    . "https://elpa.gnu.org/packages/")
	    ("nongnu" . "https://elpa.nongnu.org/nongnu/")))

(package-initialize)
#+end_src

** å®‰è£…use-packageæ’ä»¶
[[https://github.com/jwiegley/use-package][use-package]] æ˜¯ä¸€ä¸ªè®©Emacsé…ç½®æ›´åŠ ç»“æ„åŒ–æ›´åŠ æ¸…æ™°çš„ä¸€ä¸ªå®æ’ä»¶ã€‚

#+begin_src emacs-lisp
;; å®‰è£… `use-package'
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

;; é…ç½® `use-package'
(eval-and-compile
  (setq use-package-always-ensure nil)
  (setq use-package-always-defer nil)
  (setq use-package-expand-minimally nil)
  (setq use-package-enable-imenu-support t)
  (if (daemonp)
	  (setq use-package-always-demand t)))

(eval-when-compile
  (require 'use-package))

;; å®‰è£… `use-package' çš„é›†æˆæ¨¡å—
(use-package use-package-ensure-system-package
  :ensure t)
(use-package diminish
  :ensure t)
(use-package bind-key
  :ensure t)
#+end_src

** quelpaåŒ…ç®¡ç†å™¨
[[https://github.com/quelpa/quelpa][quelpa]] æ˜¯é…åˆ =package.el= ä½¿ç”¨çš„ï¼ŒåŸºäºgitçš„ä¸€ä¸ªåŒ…ç®¡ç†å™¨ã€‚
#+BEGIN_SRC emacs-lisp
;; å®‰è£… `quelpa'
(use-package quelpa
  :ensure t
  :commands quelpa
  :config
  :custom
  (quelpa-git-clone-depth 1)
  (quelpa-update-melpa-p nil)
  (quelpa-self-upgrade-p nil)
  (quelpa-checkout-melpa-p nil))

;; `quelpa' ä¸ `use-package' é›†æˆ
(use-package quelpa-use-package
  :ensure t)
#+END_SRC

** åŠ è½½æ¨¡å—åŒ–é…ç½®

#+BEGIN_SRC emacs-lisp
;; å°†lispç›®å½•æ”¾åˆ°åŠ è½½è·¯å¾„çš„å‰é¢ä»¥åŠ å¿«å¯åŠ¨é€Ÿåº¦
(let ((dir (locate-user-emacs-file "lisp")))
  (add-to-list 'load-path (file-name-as-directory dir)))

;; åŠ è½½å„æ¨¡å—åŒ–é…ç½®
;; ä¸è¦åœ¨`*message*'ç¼“å†²åŒºæ˜¾ç¤ºåŠ è½½æ¨¡å—åŒ–é…ç½®çš„ä¿¡æ¯
(with-temp-message ""
  (require 'init-base)                  ; ä¸€äº›åŸºæœ¬é…ç½®
  (require 'init-ui)                    ; UIäº¤äº’
  (require 'init-edit)                  ; ç¼–è¾‘è¡Œä¸º
  (require 'init-org)                   ; orgç›¸å…³è®¾ç½®
  (require 'init-completion)            ; è¡¥å…¨ç³»ç»Ÿ
  (require 'init-dired)                 ; æ–‡ä»¶ç®¡ç†
  (require 'init-tools)                 ; ç›¸å…³å·¥å…·
  (require 'init-dev)                   ; å¼€å‘ç›¸å…³é…ç½®
  (require 'init-mail)                  ; é‚®ä»¶é…ç½®
  (require 'init-rss)                   ; RSSé…ç½®
  (require 'init-shell)                 ; Shellé…ç½®
  )
#+END_SRC

** init.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init.el ends here
#+END_SRC

* init-ui.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-ui.el :mkdirp yes
:END:

** init-ui.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-ui.el --- UI settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** efä¸»é¢˜

[[https://protesilaos.com/emacs/ef-themes][ef themes]] æ˜¯æˆ‘éå¸¸å–œæ¬¢çš„ä¸€ä¸ªä¸»é¢˜åŒ…ã€‚

#+BEGIN_SRC emacs-lisp
(use-package ef-themes
  :ensure t
  :bind ("C-c t" . ef-themes-toggle)
  :init
  ;; set two specific themes and switch between them
  (setq ef-themes-to-toggle '(ef-summer ef-winter))
  ;; set org headings and function syntax
  (setq ef-themes-headings
        '((0 . (bold 1))
          (1 . (bold 1))
          (2 . (rainbow bold 1))
          (3 . (rainbow bold 1))
          (4 . (rainbow bold 1))
          (t . (rainbow bold 1))))
  (setq ef-themes-region '(intense no-extend neutral))
  ;; Disable all other themes to avoid awkward blending:
  (mapc #'disable-theme custom-enabled-themes)

  ;; Load the theme of choice:
  ;; The themes we provide are recorded in the `ef-themes-dark-themes',
  ;; `ef-themes-light-themes'.
  
  ;; å¦‚æœä½ ä¸å–œæ¬¢éšæœºä¸»é¢˜ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å›ºå®šé€‰æ‹©ä¸€ä¸ªä¸»é¢˜ï¼Œå¦‚ä¸‹ï¼š
  ;; (ef-themes-select 'ef-summer)

  ;; éšæœºæŒ‘é€‰ä¸€æ¬¾ä¸»é¢˜ï¼Œå¦‚æœæ˜¯å‘½ä»¤è¡Œæ‰“å¼€Emacsï¼Œåˆ™éšæœºæŒ‘é€‰ä¸€æ¬¾é»‘è‰²ä¸»é¢˜
  (if (display-graphic-p)
      (ef-themes-load-random)
    (ef-themes-load-random 'dark))

  :config
  ;; auto change theme, aligning with system themes.
  (defun my/apply-theme (appearance)
    "Load theme, taking current system APPEARANCE into consideration."
    (mapc #'disable-theme custom-enabled-themes)
    (pcase appearance
      ('light (if (display-graphic-p) (ef-themes-load-random 'light) (ef-themes-load-random 'dark)))
      ('dark (ef-themes-load-random 'dark))))

  (if (eq system-type 'darwin)
      ;; only for emacs-plus
      (add-hook 'ns-system-appearance-change-functions #'my/apply-theme)
    (ef-themes-select 'ef-summer)
    )
  )
#+END_SRC

** å­—ä½“è®¾ç½®

[[https://protesilaos.com/emacs/fontaine][fontaine]] æ’ä»¶å¯ä»¥æ ¹æ®éœ€è¦é«˜åº¦å®šåˆ¶å­—ä½“ã€‚

#+BEGIN_QUOTE
è¿™ç¯‡æ–‡ç« å¯ä»¥ä½œä¸ºå­—ä½“è®¾ç½®çš„å‚è€ƒï¼š
[[http://xahlee.info/emacs/emacs/emacs_list_and_set_font.html]]
#+END_QUOTE

#+BEGIN_SRC emacs-lisp
(use-package fontaine
  :ensure t
  :when (display-graphic-p)
  ;; :hook (kill-emacs . fontaine-store-latest-preset)
  :config
  (setq fontaine-latest-state-file
        (locate-user-emacs-file "etc/fontaine-latest-state.eld"))
  (setq fontaine-presets
        '((regular
           :default-height 140
           :default-weight regular
           :fixed-pitch-height 1.0
           :variable-pitch-height 1.0
           )
          (large
           :default-height 180
           :default-weight normal
           :fixed-pitch-height 1.0
           :variable-pitch-height 1.05
           )
          (t
           :default-family "Source Code Pro"
           :fixed-pitch-family "Source Code Pro"
           :variable-pitch-family "Source Code Pro"
           :italic-family "Source Code Pro"
           :variable-pitch-weight normal
           :bold-weight normal
           :italic-slant italic
           :line-spacing 0.1)
          ))
  ;; (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular))
  (fontaine-set-preset 'regular)

  ;; set emoji font
  (set-fontset-font
   t
   (if (version< emacs-version "28.1")
       '(#x1f300 . #x1fad0)
     'emoji)
   (cond
    ((member "Noto Emoji" (font-family-list)) "Noto Emoji")
    ((member "Symbola" (font-family-list)) "Symbola")
    ((member "Apple Color Emoji" (font-family-list)) "Apple Color Emoji")
    ((member "Noto Color Emoji" (font-family-list)) "Noto Color Emoji")
    ((member "Segoe UI Emoji" (font-family-list)) "Segoe UI Emoji")
    ))

  ;; set Chinese font
  (dolist (charset '(kana han symbol cjk-misc bopomofo))
    (set-fontset-font
     (frame-parameter nil 'font)
     charset
     (font-spec :family
                (cond
                 ((eq system-type 'darwin)
                  (cond
                   ((member "Sarasa Mono SC Nerd" (font-family-list)) "Sarasa Mono SC Nerd")
                   ((member "PingFang SC" (font-family-list)) "PingFang SC")
                   ((member "WenQuanYi Zen Hei" (font-family-list)) "WenQuanYi Zen Hei")
                   ((member "Microsoft YaHei" (font-family-list)) "Microsoft YaHei")
                   ))
                 ((eq system-type 'gnu/linux)
                  (cond
                   ((member "Sarasa Mono SC Nerd" (font-family-list)) "Sarasa Mono SC Nerd")
                   ((member "WenQuanYi Micro Hei" (font-family-list)) "WenQuanYi Micro Hei")
                   ((member "WenQuanYi Zen Hei" (font-family-list)) "WenQuanYi Zen Hei")
                   ((member "Microsoft YaHei" (font-family-list)) "Microsoft YaHei")
                   ))
                 (t
                  (cond
                   ((member "Sarasa Mono SC Nerd" (font-family-list)) "Sarasa Mono SC Nerd")
                   ((member "Microsoft YaHei" (font-family-list)) "Microsoft YaHei")
                   )))
                )))

  ;; set Chinese font scale
  (setq face-font-rescale-alist `(
                                  ("Symbola"             . 1.3)
                                  ("Microsoft YaHei"     . 1.2)
                                  ("WenQuanYi Zen Hei"   . 1.2)
                                  ("Sarasa Mono SC Nerd" . 1.2)
                                  ("PingFang SC"         . 1.16)
                                  ("Lantinghei SC"       . 1.16)
                                  ("Kaiti SC"            . 1.16)
                                  ("Yuanti SC"           . 1.16)
                                  ("Apple Color Emoji"   . 0.91)
                                  ))
  )
#+END_SRC

#+CAPTION: æµ‹è¯•ä¸­è‹±æ–‡å­—ä½“å¯¹é½
#+NAME: æµ‹è¯•ä¸­è‹±æ–‡å­—ä½“å¯¹é½
| ä¸­æ–‡ |   |
| abcd |   |

** çª—å£è®¾ç½®
*** è°ƒæ•´å¯åŠ¨çª—å£å¤§å°
åœ¨Macä¸‹ï¼Œæˆ‘çš„é»˜è®¤å¯åŠ¨çª—å£å¤§å°
#+BEGIN_SRC emacs-lisp
;; è®¾ç½®çª—å£å¤§å°ï¼Œä»…ä»…åœ¨å›¾å½¢ç•Œé¢éœ€è¦è®¾ç½®
(when (display-graphic-p)
  (let ((top    0)                                     ; é¡¶ä¸ç•™ç©º
        (left   (/ (x-display-pixel-width) 10))        ; å·¦è¾¹ç©º10%
        (height (round (* 0.8                          ; çª—ä½“é«˜åº¦ä¸º0.8å€çš„æ˜¾ç¤ºé«˜åº¦
                          (/ (x-display-pixel-height)
                             (frame-char-height))))))
    (let ((width  (round (* 2.5 height))))             ; çª—ä½“å®½åº¦ä¸º2.5å€é«˜åº¦
      (setq default-frame-alist nil)
      (add-to-list 'default-frame-alist (cons 'top top))
      (add-to-list 'default-frame-alist (cons 'left left))
      (add-to-list 'default-frame-alist (cons 'height height))
      (add-to-list 'default-frame-alist (cons 'width width)))))
#+END_SRC

** å…¶ä»–UIé›¶æ•£è®¾ç½®é¡¹

#+begin_src emacs-lisp
;; ç¦ç”¨ä¸€äº›GUIç‰¹æ€§
(setq use-dialog-box nil)               ; é¼ æ ‡æ“ä½œä¸ä½¿ç”¨å¯¹è¯æ¡†
(setq inhibit-default-init t)           ; ä¸åŠ è½½ `default' åº“
(setq inhibit-startup-screen t)         ; ä¸åŠ è½½å¯åŠ¨ç”»é¢
(setq inhibit-startup-message t)        ; ä¸åŠ è½½å¯åŠ¨æ¶ˆæ¯
(setq inhibit-startup-buffer-menu t)    ; ä¸æ˜¾ç¤ºç¼“å†²åŒºåˆ—è¡¨

;; è‰ç¨¿ç¼“å†²åŒºé»˜è®¤æ–‡å­—è®¾ç½®
(setq initial-scratch-message (concat ";; Happy hacking, "
                                      (capitalize user-login-name) " - Emacs â™¥ you!\n\n"))

;; è®¾ç½®ç¼“å†²åŒºçš„æ–‡å­—æ–¹å‘ä¸ºä»å·¦åˆ°å³
(setq bidi-paragraph-direction 'left-to-right)
;; ç¦æ­¢ä½¿ç”¨åŒå‘æ‹¬å·ç®—æ³•
;; (setq bidi-inhibit-bpa t)

;; è®¾ç½®è‡ªåŠ¨æŠ˜è¡Œå®½åº¦ä¸º80ä¸ªå­—ç¬¦ï¼Œé»˜è®¤å€¼ä¸º70
(setq-default fill-column 80)

;; è®¾ç½®å¤§æ–‡ä»¶é˜ˆå€¼ä¸º100MBï¼Œé»˜è®¤10MB
(setq large-file-warning-threshold 100000000)

;; ä»¥16è¿›åˆ¶æ˜¾ç¤ºå­—èŠ‚æ•°
(setq display-raw-bytes-as-hex t)
;; æœ‰è¾“å…¥æ—¶ç¦æ­¢ `fontification' ç›¸å…³çš„å‡½æ•°é’©å­ï¼Œèƒ½è®©æ»šåŠ¨æ›´é¡ºæ»‘
(setq redisplay-skip-fontification-on-input t)

;; ç¦æ­¢å“é“ƒ
(setq ring-bell-function 'ignore)

;; ç¦æ­¢é—ªçƒå…‰æ ‡
(blink-cursor-mode -1)

;; åœ¨å…‰æ ‡å¤„è€Œéé¼ æ ‡æ‰€åœ¨ä½ç½®ç²˜è´´
(setq mouse-yank-at-point t)

;; æ‹·è´ç²˜è´´è®¾ç½®
(setq select-enable-primary nil)        ; é€‰æ‹©æ–‡å­—æ—¶ä¸æ‹·è´
(setq select-enable-clipboard t)        ; æ‹·è´æ—¶ä½¿ç”¨å‰ªè´´æ¿

;; é¼ æ ‡æ»šåŠ¨è®¾ç½®
(setq scroll-step 2)
(setq scroll-margin 2)
(setq hscroll-step 2)
(setq hscroll-margin 2)
(setq scroll-conservatively 101)
(setq scroll-up-aggressively 0.01)
(setq scroll-down-aggressively 0.01)
(setq scroll-preserve-screen-position 'always)

;; å¯¹äºé«˜çš„è¡Œç¦æ­¢è‡ªåŠ¨å‚ç›´æ»šåŠ¨
(setq auto-window-vscroll nil)

;; è®¾ç½®æ–°åˆ†å±æ‰“å¼€çš„ä½ç½®çš„é˜ˆå€¼
(setq split-width-threshold (assoc-default 'width default-frame-alist))
(setq split-height-threshold nil)

;; TABé”®è®¾ç½®ï¼Œåœ¨Emacsé‡Œä¸ä½¿ç”¨TABé”®ï¼Œæ‰€æœ‰çš„TABé»˜è®¤ä¸º4ä¸ªç©ºæ ¼
(setq-default indent-tabs-mode nil)
(setq-default tab-width 4)

;; yesæˆ–noæç¤ºè®¾ç½®ï¼Œé€šè¿‡ä¸‹é¢è¿™ä¸ªå‡½æ•°è®¾ç½®å½“ç¼“å†²åŒºåå­—åŒ¹é…åˆ°é¢„è®¾çš„å­—ç¬¦ä¸²æ—¶è‡ªåŠ¨å›ç­”yes
(setq original-y-or-n-p 'y-or-n-p)
(defalias 'original-y-or-n-p (symbol-function 'y-or-n-p))
(defun default-yes-sometimes (prompt)
  "automatically say y when buffer name match following string"
  (if (or
	   (string-match "has a running process" prompt)
	   (string-match "does not exist; create" prompt)
	   (string-match "modified; kill anyway" prompt)
	   (string-match "Delete buffer using" prompt)
	   (string-match "Kill buffer of" prompt)
	   (string-match "still connected.  Kill it?" prompt)
	   (string-match "Shutdown the client's kernel" prompt)
	   (string-match "kill them and exit anyway" prompt)
	   (string-match "Revert buffer from file" prompt)
	   (string-match "Kill Dired buffer of" prompt)
	   (string-match "delete buffer using" prompt)
       (string-match "Kill all pass entry" prompt)
       (string-match "for all cursors" prompt)
	   (string-match "Do you want edit the entry" prompt))
	  t
    (original-y-or-n-p prompt)))
(defalias 'yes-or-no-p 'default-yes-sometimes)
(defalias 'y-or-n-p 'default-yes-sometimes)

;; è®¾ç½®å‰ªè´´æ¿å†å²é•¿åº¦300ï¼Œé»˜è®¤ä¸º60
(setq kill-ring-max 200)

;; åœ¨å‰ªè´´æ¿é‡Œä¸å­˜å‚¨é‡å¤å†…å®¹
(setq kill-do-not-save-duplicates t)

;; è®¾ç½®ä½ç½®è®°å½•é•¿åº¦ä¸º6ï¼Œé»˜è®¤ä¸º16
;; å¯ä»¥ä½¿ç”¨ `counsel-mark-ring' or `consult-mark' (C-x j) æ¥è®¿é—®å…‰æ ‡ä½ç½®è®°å½•
;; ä½¿ç”¨ C-x C-SPC æ‰§è¡Œ `pop-global-mark' ç›´æ¥è·³è½¬åˆ°ä¸Šä¸€ä¸ªå…¨å±€ä½ç½®å¤„
;; ä½¿ç”¨ C-u C-SPC è·³è½¬åˆ°æœ¬åœ°ä½ç½®å¤„
(setq mark-ring-max 6)
(setq global-mark-ring-max 6)

;; è®¾ç½® emacs-lisp çš„é™åˆ¶
(setq max-lisp-eval-depth 10000)        ; é»˜è®¤å€¼ä¸º 800
(setq max-specpdl-size 10000)           ; é»˜è®¤å€¼ä¸º 1600

;; å¯ç”¨ `list-timers', `list-threads' è¿™ä¸¤ä¸ªå‘½ä»¤
(put 'list-timers 'disabled nil)
(put 'list-threads 'disabled nil)

;; åœ¨å‘½ä»¤è¡Œé‡Œæ”¯æŒé¼ æ ‡
(xterm-mouse-mode 1)

;; é€€å‡ºEmacsæ—¶è¿›è¡Œç¡®è®¤
(setq confirm-kill-emacs 'y-or-n-p)

;; åœ¨æ¨¡å¼æ ä¸Šæ˜¾ç¤ºå½“å‰å…‰æ ‡çš„åˆ—å·
(column-number-mode t)
#+end_src

** ç¼–ç è®¾ç½®

ç»Ÿä¸€ä½¿ç”¨ UTF-8 ç¼–ç ã€‚

#+begin_src emacs-lisp
;; é…ç½®æ‰€æœ‰çš„ç¼–ç ä¸ºUTF-8ï¼Œå‚è€ƒï¼š
;; https://thraxys.wordpress.com/2016/01/13/utf-8-in-emacs-everywhere-forever/
(setq locale-coding-system 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(set-default-coding-systems 'utf-8)
(set-language-environment 'utf-8)
(set-clipboard-coding-system 'utf-8)
(set-file-name-coding-system 'utf-8)
(set-buffer-file-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
(modify-coding-system-alist 'process "*" 'utf-8)
(when (display-graphic-p)
  (setq x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)))
#+end_src

** æ¨¡å¼æ è®¾ç½®
*** doom-modelineæ’ä»¶

[[https://github.com/seagle0128/doom-modeline][doom-modeline]] æ˜¯ä¸€ä¸ªæ¨¡å¼æ ç¾åŒ–æ’ä»¶ã€‚

#+begin_src emacs-lisp
(use-package doom-modeline
  :ensure t
  :hook (after-init . doom-modeline-mode)
  :custom
  (doom-modeline-irc nil)
  (doom-modeline-mu4e nil)
  (doom-modeline-gnus nil)
  (doom-modeline-github nil)
  (doom-modeline-buffer-file-name-style 'truncate-upto-root) ; : auto
  (doom-modeline-persp-name nil)
  (doom-modeline-unicode-fallback t)
  (doom-modeline-enable-word-count nil))
#+end_src

*** minionsæ’ä»¶
[[https://github.com/tarsius/minions][minions]] æ’ä»¶èƒ½è®©æ¨¡å¼æ å˜å¾—æ¸…çˆ½ï¼Œå°†æ¬¡è¦æ¨¡å¼éšè—èµ·æ¥ã€‚

#+BEGIN_SRC emacs-lisp
(use-package minions
  :ensure t
  :hook (after-init . minions-mode))
#+END_SRC

*** keycastæŒ‰é”®å±•ç¤º
[[https://github.com/tarsius/keycast][keycast mode]] æ’ä»¶å¯ä»¥åœ¨æ¨¡å¼æ ä¸Šå±•ç¤ºæ‰€æœ‰çš„æŒ‰é”®ï¼Œä»¥åŠå¯¹åº”çš„å‡½æ•°ã€‚

#+BEGIN_SRC emacs-lisp
(use-package keycast
  :ensure t
  :hook (after-init . keycast-mode)
  :config
  ;; set for doom-modeline support
  ;; With the latest change 72d9add, mode-line-keycast needs to be modified to keycast-mode-line.
  (define-minor-mode keycast-mode
    "Show current command and its key binding in the mode line (fix for use with doom-mode-line)."
    :global t
    (if keycast-mode
        (progn
          (add-hook 'pre-command-hook 'keycast--update t)
          (add-to-list 'global-mode-string '("" keycast-mode-line "  ")))
      (remove-hook 'pre-command-hook 'keycast--update)
      (setq global-mode-string (delete '("" keycast-mode-line "  ") global-mode-string))
      ))

  (dolist (input '(self-insert-command
                   org-self-insert-command))
    (add-to-list 'keycast-substitute-alist `(,input "." "Typingâ€¦")))

  (dolist (event '(mouse-event-p
                   mouse-movement-p
                   mwheel-scroll))
    (add-to-list 'keycast-substitute-alist `(,event nil)))

  (setq keycast-log-format "%-20K%C\n")
  (setq keycast-log-frame-alist
        '((minibuffer . nil)))
  (setq keycast-log-newest-first t)
  )
#+END_SRC

** notificationsé€šçŸ¥ç®¡ç†

éœ€è¦å…ˆé€šè¿‡ ~brew install terminal-notifier~ å‘½ä»¤å®‰è£… [[https://github.com/julienXX/terminal-notifier][terminal-notifier]] ã€‚

#+BEGIN_SRC emacs-lisp
(use-package notifications
  :ensure nil
  :commands notify-send
  :config
  (cond ((eq system-type 'darwin)
         (defun notify-send (&rest params)
           "Send notifications via `terminal-notifier'."
           (let ((title (plist-get params :title))
                 (body (plist-get params :body)))
             (start-process "terminal-notifier"
                            nil
                            "terminal-notifier"
                            "-group" "Emacs"
                            "-title" title
                            "-message" body
                            "-activate" "org.gnu.Emacs"))))
        (t
         (defalias 'notify-send 'notifications-notify)))
  )
#+END_SRC

** å›¾æ ‡è®¾ç½®

#+BEGIN_SRC emacs-lisp
(use-package all-the-icons
  :ensure t
  :when (display-graphic-p)
  :commands all-the-icons-install-fonts
  )
#+END_SRC

** init-ui.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-ui)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-ui.el ends here
#+END_SRC

* init-base.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-base.el :mkdirp yes
:END:

** init-base.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-base.el --- Basical settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** no-litteringè®©é…ç½®ç›®å½•ç®€æ´
[[https://github.com/emacscollective/no-littering][no-littering]] æ’ä»¶å°†åŸæœ¬æ”¾åœ¨ =.emacs.d= ç›®å½•ä¸‹çš„ä¸€äº›é…ç½®ä¿¡æ¯æˆ–åŠ¨æ€ä¿¡æ¯ï¼Œè½¬ç§»åˆ° =etc= æˆ– =var= å­ç›®å½•é‡Œï¼Œè®©é…ç½®ç›®å½•æ›´åŠ ç®€æ´æ¸…çˆ½ã€‚

#+begin_src emacs-lisp
(use-package no-littering
  :ensure t)
#+end_src

** savehistè®°ä½è¿·ä½ ç¼“å†²åŒºå†å²
è®°ä½è¿·ä½ ç¼“å†²åŒºå†å²ã€‚

#+BEGIN_SRC emacs-lisp
(use-package savehist
  :ensure nil
  :hook (after-init . savehist-mode)
  :config
  ;; Allow commands in minibuffers, will affect `dired-do-dired-do-find-regexp-and-replace' command:
  (setq enable-recursive-minibuffers t)
  (setq history-length 1000)
  (setq savehist-additional-variables '(mark-ring
                                        global-mark-ring
                                        search-ring
                                        regexp-search-ring
                                        extended-command-history))
  (setq savehist-autosave-interval 300))
#+END_SRC

** saveplaceè®°ä½æ¯ä¸ªæ–‡ä»¶çš„å…‰æ ‡ä½ç½®
è‡ªåŠ¨è®°ä½æ¯ä¸ªæ–‡ä»¶çš„æœ€åä¸€æ¬¡è®¿é—®çš„å…‰æ ‡ä½ç½®ã€‚

#+begin_src emacs-lisp
(use-package saveplace
  :ensure nil
  :hook (after-init . save-place-mode))
#+end_src

** recentfæœ€è¿‘æ‰“å¼€çš„æ–‡ä»¶å†å²
è®°ä½æœ€è¿‘æ‰“å¼€çš„æ–‡ä»¶å†å²ã€‚

#+begin_src emacs-lisp
(use-package recentf
  :ensure nil
  :defines no-littering-etc-directory no-littering-var-directory
  :hook (after-init . recentf-mode)
  :custom
  (recentf-max-saved-items 300)
  (recentf-auto-cleanup 'never)
  ;; `recentf-add-file' will apply handlers first, then call `string-prefix-p'
  ;; to check if it can be pushed to recentf list.
  (recentf-filename-handlers '(abbreviate-file-name))
  (recentf-exclude `(,@(cl-loop for f in `(,package-user-dir
                                           ,no-littering-var-directory
                                           ,no-littering-etc-directory)
                                collect (abbreviate-file-name f))
                     ;; Folders on MacOS start
                     "^/private/tmp/"
                     "^/var/folders/"
                     ;; Folders on MacOS end
                     ".cache"
                     ".cask"
                     ".elfeed"
                     "elfeed"
                     "bookmarks"
                     "cache"
                     "ido.*"
                     "persp-confs"
                     "recentf"
                     "undo-tree-hist"
                     "url"
                     "^/tmp/"
                     "/ssh\\(x\\)?:"
                     "/su\\(do\\)?:"
                     "^/usr/include/"
                     "/TAGS\\'"
                     "COMMIT_EDITMSG\\'")))
#+end_src

** undo-treeæ’¤é”€è®¾ç½®

[[https://www.dr-qubit.org/undo-tree.html][undo-tree]] æ’ä»¶å¯ä»¥æä¾›ä¸€ä¸ªå¯è§†åŒ–çš„æ’¤é”€ã€é‡åšç³»ç»Ÿï¼Œæˆ‘ä»¬ä½¿ç”¨ =C-/= æ¥æ’¤é”€ï¼Œä½¿ç”¨ =M-_= æ¥é‡åšã€‚

#+begin_src emacs-lisp
(use-package undo-tree
  :ensure t
  :hook (after-init . global-undo-tree-mode)
  :config
  ;; don't save undo history to local files
  (setq undo-tree-auto-save-history nil)
  )
#+end_src

** super-saveè‡ªåŠ¨ä¿å­˜

[[https://github.com/bbatsov/super-save][super-save]] æ’ä»¶èƒ½è‡ªåŠ¨ä¿å­˜ç¼“å†²åŒºã€‚å®ƒå¯ä»¥è®¾ç½®åœ¨æŸäº›è¡Œä¸ºï¼ˆå¦‚çª—å£åˆ‡æ¢ã€æˆ–çª—å£ç©ºé—²ä¸€æ®µæ—¶é—´ï¼‰ä¸‹è‡ªåŠ¨ä¿å­˜ã€‚

#+BEGIN_SRC emacs-lisp
(use-package super-save
  :ensure t
  :hook (after-init . super-save-mode)
  :config
  ;; Emacsç©ºé—²æ˜¯å¦è‡ªåŠ¨ä¿å­˜ï¼Œè¿™é‡Œä¸è®¾ç½®
  (setq super-save-auto-save-when-idle nil)
  ;; åˆ‡æ¢çª—å£è‡ªåŠ¨ä¿å­˜
  (add-to-list 'super-save-triggers 'other-window)
  ;; æŸ¥æ‰¾æ–‡ä»¶æ—¶è‡ªåŠ¨ä¿å­˜
  (add-to-list 'super-save-hook-triggers 'find-file-hook)
  ;; è¿œç¨‹æ–‡ä»¶ç¼–è¾‘ä¸è‡ªåŠ¨ä¿å­˜
  (setq super-save-remote-files nil)
  ;; ç‰¹å®šåç¼€åçš„æ–‡ä»¶ä¸è‡ªåŠ¨ä¿å­˜
  (setq super-save-exclude '(".gpg"))
  ;; è‡ªåŠ¨ä¿å­˜æ—¶ï¼Œä¿å­˜æ‰€æœ‰ç¼“å†²åŒº
  (defun super-save/save-all-buffers ()
    (save-excursion
      (dolist (buf (buffer-list))
        (set-buffer buf)
        (when (and buffer-file-name
                   (buffer-modified-p (current-buffer))
                   (file-writable-p buffer-file-name)
                   (if (file-remote-p buffer-file-name) super-save-remote-files t))
          (save-buffer)))))
  (advice-add 'super-save-command :override 'super-save/save-all-buffers)
  )
#+END_SRC

** cruxç³»ç»Ÿå¢å¼º
[[https://github.com/bbatsov/crux][crux]] æ’ä»¶æä¾›ä¸€ç³»åˆ—çš„å¢å¼ºï¼Œå¦‚ç§»åŠ¨å¢å¼ºã€åˆ é™¤å¢å¼ºç­‰ä¼˜åŒ–åŠŸèƒ½ã€‚

#+begin_src emacs-lisp
(use-package crux
  :ensure t
  :bind (("C-a" . crux-move-beginning-of-line)
         ("C-x 4 t" . crux-transpose-windows)
         ("C-x K" . crux-kill-other-buffers)
         ("C-k" . crux-smart-kill-line)
         ("C-c r" . crux-rename-file-and-buffer)
         ("C-x DEL" . crux-kill-line-backwards))
  :config
  (crux-with-region-or-buffer indent-region)
  (crux-with-region-or-buffer untabify)
  (crux-with-region-or-point-to-eol kill-ring-save)
  (defalias 'rename-file-and-buffer #'crux-rename-file-and-buffer))
#+end_src

** ä¸ªäººå‡½æ•°å®šä¹‰

ä»¥ä¸‹æ˜¯ä¸€äº›ä¸ªäººçš„å‡½æ•°å®šä¹‰ï¼Œé…ç½®æ–‡ä»¶çš„å…¶ä»–éƒ¨åˆ†ä¼šç”¨åˆ°è¿™äº›å‡½æ•°ã€‚

#+BEGIN_SRC emacs-lisp
;; å°†åˆ—è¡¨åŠ å…¥åˆ°åˆ—è¡¨
(defun add-list-to-list (dst src)
  "Similar to `add-to-list', but accepts a list as 2nd argument"
  (set dst
       (append (eval dst) src)))

;; æ‰“å¼€å½“å‰é…ç½®Orgæ–‡ä»¶
(defun open-emacsconfig ()
  "Opens emacs config org file."
  (interactive)
  (find-file (locate-user-emacs-file "emacs-config.org")))
#+END_SRC

** åˆ«åå®šä¹‰

å®šä¹‰äº†åˆ«ååï¼Œå¯ä»¥é€šè¿‡ =M-x åˆ«å= çš„æ–¹å¼æ¥è°ƒç”¨æŸä¸ªå‘½ä»¤ã€‚

#+BEGIN_SRC emacs-lisp
(defalias 'e #'eshell)
(defalias 's #'scratch)
(defalias 'conf #'open-emacsconfig)
#+END_SRC

** init-base.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-base)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-base.el ends here
#+END_SRC

* init-edit.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-edit.el :mkdirp yes
:END:

** init-edit.el æ–‡ä»¶å¤´

#+BEGIN_SRC emacs-lisp
;;; init-edit.el --- Editing settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** Emacså¤‡ä»½è®¾ç½®

ä¸ä½¿ç”¨Emacsçš„è‡ªåŠ¨å¤‡ä»½è®¾ç½®ã€‚

#+BEGIN_SRC emacs-lisp
(setq make-backup-files nil)                                  ; ä¸è‡ªåŠ¨å¤‡ä»½
(setq auto-save-default nil)                                  ; ä¸ä½¿ç”¨Emacsè‡ªå¸¦çš„è‡ªåŠ¨ä¿å­˜
#+END_SRC

** è§£é™¤ä¸€äº›ä¸å¸¸ç”¨çš„å¿«æ·é”®

å°†ä¸€äº›ä¸å¸¸ç”¨çš„å¿«æ·é”®è§£é™¤ï¼Œé˜²æ­¢è¯¯æ“ä½œã€‚

#+BEGIN_SRC emacs-lisp
;; è§£é™¤ä¸å¸¸ç”¨çš„å¿«æ·é”®å®šä¹‰
(global-set-key (kbd "C-z") nil)
(global-set-key (kbd "s-q") nil)
(global-set-key (kbd "M-z") nil)
(global-set-key (kbd "M-m") nil)
(global-set-key (kbd "C-x C-z") nil)
(global-set-key [mouse-2] nil)
#+END_SRC

** delselé€‰æ‹©æ–‡æœ¬è¾“å…¥æ—¶ç›´æ¥æ›¿æ¢

Emacsé»˜è®¤é€‰æ‹©æ–‡æœ¬åç›´æ¥è¾“å…¥ï¼Œæ˜¯ä¸ä¼šç›´æ¥åˆ é™¤æ‰€é€‰æ‹©çš„æ–‡æœ¬è¿›è¡Œæ›¿æ¢çš„ã€‚é€šè¿‡å†…ç½®çš„ =delsel= æ’ä»¶æ¥å®ç°è¿™ä¸ªè¡Œä¸ºã€‚

#+begin_src emacs-lisp
;; Directly modify when selecting text
(use-package delsel
  :ensure nil
  :hook (after-init . delete-selection-mode))
#+end_src

** è‡ªåŠ¨é‡è½½è®¾ç½®

å½“æˆ‘ä»¬çš„æ–‡ä»¶å‘ç”Ÿäº†æ”¹å˜åï¼Œæˆ‘ä»¬å¸Œæœ›Emacsé‡Œæ‰“å¼€çš„æ°¸è¿œæ˜¯æœ€æ–°çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è‡ªåŠ¨é‡è½½è¿›è¡Œè®¾ç½®ï¼Œè®©æˆ‘ä»¬çš„Emacsåœ¨æ–‡ä»¶å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è‡ªåŠ¨é‡è½½æ–‡ä»¶ã€‚

#+BEGIN_SRC emacs-lisp
(use-package autorevert
  :ensure nil
  :hook (after-init . global-auto-revert-mode)
  :bind ("s-u" . revert-buffer)
  :custom
  (auto-revert-interval 10)
  (auto-revert-avoid-polling t)
  (auto-revert-verbose nil)
  (auto-revert-remote-files t)
  (auto-revert-check-vc-info t)
  (global-auto-revert-non-file-buffers t))
#+END_SRC

** avyå…‰æ ‡ç§»åŠ¨

[[https://github.com/abo-abo/avy][avy]] æ˜¯ä¸€ä¸ªå…‰æ ‡ç§»åŠ¨æ’ä»¶ï¼Œèƒ½å¿«é€Ÿå°†å…‰æ ‡ç§»åŠ¨åˆ°å±å¹•ä¸Šçš„ä»»æ„å­—ç¬¦ï¼Œéå¸¸å¼ºå¤§ï¼

#+begin_src emacs-lisp
(use-package avy
  :ensure t
  :bind (("C-." . my/avy-goto-char-timer)
         ("C-ã€‚" . my/avy-goto-char-timer)
         :map isearch-mode-map
         ("C-." . avy-isearch))
  :config
  ;; Make `avy-goto-char-timer' support pinyin, refer to:
  ;; https://emacs-china.org/t/avy-avy-goto-char-timer/20900/2
  (defun my/avy-goto-char-timer (&optional arg)
    "Make avy-goto-char-timer support pinyin"
    (interactive "P")
    (let ((avy-all-windows (if arg
                               (not avy-all-windows)
                             avy-all-windows)))
      (avy-with avy-goto-char-timer
        (setq avy--old-cands (avy--read-candidates
                              'pinyinlib-build-regexp-string))
        (avy-process avy--old-cands))))

  (defun avy-action-kill-whole-line (pt)
    "avy action: kill the whole line where avy selection is"
    (save-excursion
      (goto-char pt)
      (kill-whole-line))
    (select-window
     (cdr
      (ring-ref avy-ring 0)))
    t)

  (defun avy-action-copy-whole-line (pt)
    "avy action: copy the whole line where avy selection is"
    (save-excursion
      (goto-char pt)
      (cl-destructuring-bind (start . end)
          (bounds-of-thing-at-point 'line)
        (copy-region-as-kill start end)))
    (select-window
     (cdr
      (ring-ref avy-ring 0)))
    t)

  (defun avy-action-yank-whole-line (pt)
    "avy action: copy the line where avy selection is and paste to current point"
    (avy-action-copy-whole-line pt)
    (save-excursion (yank))
    t)

  (defun avy-action-teleport-whole-line (pt)
    "avy action: kill the line where avy selection is and paste to current point"
    (avy-action-kill-whole-line pt)
    (save-excursion (yank)) t)

  (defun avy-action-helpful (pt)
    "avy action: get helpful information at point"
    (save-excursion
      (goto-char pt)
      (helpful-at-point))
    ;; (select-window
    ;;  (cdr (ring-ref avy-ring 0)))
    t)

  (defun avy-action-mark-to-char (pt)
    "avy action: mark from current point to avy selection"
    (activate-mark)
    (goto-char pt))

  (defun avy-action-flyspell (pt)
    "avy action: flyspell the word where avy selection is"
    (save-excursion
      (goto-char pt)
      (when (require 'flyspell nil t)
        (flyspell-correct-wrapper))))

  (defun avy-action-define (pt)
    "avy action: define the word in dictionary where avy selection is"
    (save-excursion
      (goto-char pt)
      (fanyi-dwim2)))

  (defun avy-action-embark (pt)
    "avy action: embark where avy selection is"
    (unwind-protect
        (save-excursion
          (goto-char pt)
          (embark-act))
      (select-window
       (cdr (ring-ref avy-ring 0))))
    t)

  (defun avy-action-google (pt)
    "avy action: google the avy selection when it is a word or browse it when it is a link"
    (save-excursion
      (goto-char pt)
      (my/search-or-browse)))

  (setf (alist-get ?k avy-dispatch-alist) 'avy-action-kill-stay
        (alist-get ?K avy-dispatch-alist) 'avy-action-kill-whole-line
        (alist-get ?w avy-dispatch-alist) 'avy-action-copy
        (alist-get ?W avy-dispatch-alist) 'avy-action-copy-whole-line
        (alist-get ?y avy-dispatch-alist) 'avy-action-yank
        (alist-get ?Y avy-dispatch-alist) 'avy-action-yank-whole-line
        (alist-get ?t avy-dispatch-alist) 'avy-action-teleport
        (alist-get ?T avy-dispatch-alist) 'avy-action-teleport-whole-line
        (alist-get ?H avy-dispatch-alist) 'avy-action-helpful
        (alist-get ?  avy-dispatch-alist) 'avy-action-mark-to-char
        (alist-get ?\; avy-dispatch-alist) 'avy-action-flyspell
        (alist-get ?= avy-dispatch-alist) 'avy-action-define
        (alist-get ?o avy-dispatch-alist) 'avy-action-embark
        (alist-get ?G avy-dispatch-alist) 'avy-action-google
        )

  :custom
  ;; (avy-case-fold-search t)              ; default is t
  (avy-timeout-seconds 1.0)
  (avy-all-windows t)
  (avy-background t)
  (avy-keys '(?a ?s ?d ?f ?g ?h ?j ?l ?q ?e ?r ?u ?i ?p ?n))
  )
#+end_src

** multiple-cursorså¤šå…‰æ ‡ç¼–è¾‘
[[https://github.com/magnars/multiple-cursors.el][multiple-cursors]] æ’ä»¶èƒ½è®©Emacså®ç°å¤šå…‰æ ‡ç¼–è¾‘å’Œç§»åŠ¨ã€‚

#+BEGIN_SRC emacs-lisp
(use-package multiple-cursors
  :ensure t
  :bind-keymap ("C-c o" . multiple-cursors-map)
  :bind (("C-`"   . mc/mark-next-like-this)
         ("C-\\"  . mc/unmark-next-like-this)
         :map multiple-cursors-map
              ("SPC" . mc/edit-lines)
              (">"   . mc/mark-next-like-this)
              ("<"   . mc/mark-previous-like-this)
              ("a"   . mc/mark-all-like-this)
              ("n"   . mc/mark-next-like-this-word)
              ("p"   . mc/mark-previous-like-this-word)
              ("r"   . set-rectangular-region-anchor)
              )
  :config
  (defvar multiple-cursors-map nil "keymap for `multiple-cursors")
  (setq multiple-cursors-map (make-sparse-keymap))
  (setq mc/list-file (concat user-emacs-directory "/etc/mc-lists.el"))
  (setq mc/always-run-for-all t)
  )
#+END_SRC

** init-edit.el æ–‡ä»¶å°¾

#+BEGIN_SRC emacs-lisp
;; (message "init-base configuration: %.2fs"
;;          (float-time (time-subtract (current-time) my/init-base-start-time)))

(provide 'init-edit)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-edit.el ends here
#+END_SRC

* init-org.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-org.el :mkdirp yes
:END:

** init-org.el æ–‡ä»¶å¤´

#+BEGIN_SRC emacs-lisp
;;; init-org.el --- Org mode settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** Org modeåŸºæœ¬é…ç½®

å¯¹Org modeåŸºæœ¬é…ç½®è¿›è¡Œä¿®æ”¹ã€‚

#+BEGIN_SRC emacs-lisp
(use-package org
  :ensure nil
  :mode ("\\.org\\'" . org-mode)
  :hook ((org-mode . visual-line-mode)
		 (org-mode . my/org-prettify-symbols))
  :commands (org-find-exact-headline-in-buffer org-set-tags)
  :custom-face
  ;; è®¾ç½®Org modeæ ‡é¢˜ä»¥åŠæ¯çº§æ ‡é¢˜è¡Œçš„å¤§å°
  (org-document-title ((t (:height 1.75 :weight bold))))
  (org-level-1 ((t (:height 1.2 :weight bold))))
  (org-level-2 ((t (:height 1.15 :weight bold))))
  (org-level-3 ((t (:height 1.1 :weight bold))))
  (org-level-4 ((t (:height 1.05 :weight bold))))
  (org-level-5 ((t (:height 1.0 :weight bold))))
  (org-level-6 ((t (:height 1.0 :weight bold))))
  (org-level-7 ((t (:height 1.0 :weight bold))))
  (org-level-8 ((t (:height 1.0 :weight bold))))
  (org-level-9 ((t (:height 1.0 :weight bold))))
  ;; è®¾ç½®ä»£ç å—ç”¨ä¸Šä¸‹è¾¹çº¿åŒ…è£¹
  (org-block-begin-line ((t (:underline t :background unspecified))))
  (org-block-end-line ((t (:overline t :underline nil :background unspecified))))
  :config
  ;; ================================
  ;; åœ¨org modeé‡Œç¾åŒ–å­—ç¬¦ä¸²
  ;; ================================
  (defun my/org-prettify-symbols ()
	(setq prettify-symbols-alist
		  (mapcan (lambda (x) (list x (cons (upcase (car x)) (cdr x))))
				  '(
					;; ("[ ]"              . 9744)         ; â˜
					;; ("[X]"              . 9745)         ; â˜‘
					;; ("[-]"              . 8863)         ; âŠŸ
					("#+begin_src"      . 9998)         ; âœ
					("#+end_src"        . 9633)         ; â–¡
					("#+begin_example"  . 129083)       ; ğŸ »
					("#+end_example"    . 129081)       ; ğŸ ¹
					("#+results:"       . 9776)         ; â˜°
					("#+attr_latex:"    . "ğŸ„›")
					("#+attr_html:"     . "ğŸ„—")
					("#+attr_org:"      . "ğŸ„")
					("#+name:"          . "ğŸ„")         ; 127261
					("#+caption:"       . "ğŸ„’")         ; 127250
					("#+date:"          . "ğŸ“…")         ; 128197
					("#+author:"        . "ğŸ’")         ; 128100
					("#+setupfile:"     . 128221)       ; ğŸ“
					("#+email:"         . 128231)       ; ğŸ“§
					("#+startup:"       . 10034)        ; âœ²
					("#+options:"       . 9965)         ; â›­
					("#+title:"         . 10162)        ; â²
					("#+subtitle:"      . 11146)        ; â®Š
					("#+downloaded:"    . 8650)         ; â‡Š
					("#+language:"      . 128441)       ; ğŸ–¹
					("#+begin_quote"    . 187)          ; Â»
					("#+end_quote"      . 171)          ; Â«
                    ("#+begin_results"  . 8943)         ; â‹¯
                    ("#+end_results"    . 8943)         ; â‹¯
					)))
    (setq prettify-symbols-unprettify-at-point t)
	(prettify-symbols-mode 1))

  ;; æå‡latexé¢„è§ˆçš„å›¾ç‰‡æ¸…æ™°åº¦
  (plist-put org-format-latex-options :scale 1.8)

  ;; è®¾ç½®æ ‡é¢˜è¡Œä¹‹é—´æ€»æ˜¯æœ‰ç©ºæ ¼ï¼›åˆ—è¡¨ä¹‹é—´æ ¹æ®æƒ…å†µè‡ªåŠ¨åŠ ç©ºæ ¼
  (setq org-blank-before-new-entry '((heading . t)
									 (plain-list-item . auto)
									 ))

  ;; ======================================
  ;; è®¾ç½®æ‰“å¼€Org linksçš„ç¨‹åº
  ;; ======================================
  (defun my-func/open-and-play-gif-image (file &optional link)
	"Open and play GIF image `FILE' in Emacs buffer.

Optional for Org-mode file: `LINK'."
	(let ((gif-image (create-image file))
		  (tmp-buf (get-buffer-create "*Org-mode GIF image animation*")))
	  (switch-to-buffer tmp-buf)
	  (erase-buffer)
	  (insert-image gif-image)
	  (image-animate gif-image nil t)
	  (local-set-key (kbd "q") 'bury-buffer)
	  ))
  (setq org-file-apps '(("\\.png\\'"     . default)
                        (auto-mode       . emacs)
                        (directory       . emacs)
                        ("\\.mm\\'"      . default)
                        ("\\.x?html?\\'" . default)
                        ("\\.pdf\\'"     . emacs)
                        ("\\.md\\'"      . emacs)
                        ("\\.gif\\'"     . my-func/open-and-play-gif-image)
                        ("\\.xlsx\\'"    . default)
                        ("\\.svg\\'"     . default)
                        ("\\.pptx\\'"    . default)
                        ("\\.docx\\'"    . default)))

  :custom
  ;; è®¾ç½®Org modeçš„ç›®å½•
  (org-directory "~/org")
  ;; è®¾ç½®ç¬”è®°çš„é»˜è®¤å­˜å‚¨ä½ç½®
  (org-default-notes-file (expand-file-name "capture.org" org-directory))
  ;; å¯ç”¨ä¸€äº›å­æ¨¡å—
  (org-modules '(ol-bibtex ol-gnus ol-info ol-eww org-habit org-protocol))
  ;; åœ¨æŒ‰M-RETæ—¶ï¼Œæ˜¯å¦æ ¹æ®å…‰æ ‡æ‰€åœ¨çš„ä½ç½®åˆ†è¡Œï¼Œè¿™é‡Œè®¾ç½®ä¸ºæ˜¯
  ;; (org-M-RET-may-split-line '((default . nil)))
  ;; ä¸€äº›Org modeè‡ªå¸¦çš„ç¾åŒ–è®¾ç½®
  ;; æ ‡é¢˜è¡Œç¾åŒ–
  (org-fontify-whole-heading-line t)
  ;; è®¾ç½®æ ‡é¢˜è¡ŒæŠ˜å ç¬¦å·
  (org-ellipsis " â–¾")
  ;; åœ¨æ´»åŠ¨åŒºåŸŸå†…çš„æ‰€æœ‰æ ‡é¢˜æ æ‰§è¡ŒæŸäº›å‘½ä»¤
  (org-loop-over-headlines-in-active-region t)
  ;; TODOæ ‡ç­¾ç¾åŒ–
  (org-fontify-todo-headline t)
  ;; DONEæ ‡ç­¾ç¾åŒ–
  (org-fontify-done-headline t)
  ;; å¼•ç”¨å—ç¾åŒ–
  (org-fontify-quote-and-verse-blocks t)
  ;; éšè—å®æ ‡è®°
  (org-hide-macro-markers t)
  ;; éšè—å¼ºè°ƒæ ‡ç­¾
  (org-hide-emphasis-markers t)
  ;; é«˜äº®latexè¯­æ³•
  (org-highlight-latex-and-related '(native script entities))
  ;; ä»¥UTF-8æ˜¾ç¤º
  (org-pretty-entities t)
  ;; æ˜¯å¦éšè—æ ‡é¢˜æ çš„å‰ç½®æ˜Ÿå·ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡org-modernæ¥éšè—
  ;; (org-hide-leading-stars t)
  ;; å½“å¯ç”¨ç¼©è¿›æ¨¡å¼æ—¶è‡ªåŠ¨éšè—å‰ç½®æ˜Ÿå·
  (org-indent-mode-turns-on-hiding-stars t)
  ;; è‡ªåŠ¨å¯ç”¨ç¼©è¿›
  (org-startup-indented nil)
  ;; æ ¹æ®æ ‡é¢˜æ è‡ªåŠ¨ç¼©è¿›æ–‡æœ¬
  (org-adapt-indentation nil)
  ;; è‡ªåŠ¨æ˜¾ç¤ºå›¾ç‰‡
  (org-startup-with-inline-images t)
  ;; é»˜è®¤ä»¥Overviewçš„æ¨¡å¼å±•ç¤ºæ ‡é¢˜è¡Œ
  (org-startup-folded 'overview)
  ;; å…è®¸å­—æ¯åˆ—è¡¨
  (org-list-allow-alphabetical t)
  ;; åˆ—è¡¨çš„ä¸‹ä¸€çº§è®¾ç½®
  (org-list-demote-modify-bullet '(
								   ("-"  . "+")
                                   ("+"  . "1.")
								   ("1." . "a.")
								   ))
  ;; ç¼–è¾‘æ—¶æ£€æŸ¥æ˜¯å¦åœ¨æŠ˜å çš„ä¸å¯è§åŒºåŸŸ
  (org-fold-catch-invisible-edits 'smart)
  ;; åœ¨å½“å‰ä½ç½®æ’å…¥æ–°æ ‡é¢˜è¡Œè¿˜æ˜¯åœ¨å½“å‰æ ‡é¢˜è¡Œåæ’å…¥ï¼Œè¿™é‡Œè®¾ç½®ä¸ºå½“å‰ä½ç½®
  (org-insert-heading-respect-content nil)
  ;; è®¾ç½®å›¾ç‰‡çš„æœ€å¤§å®½åº¦ï¼Œå¦‚æœæœ‰imagemagickæ”¯æŒå°†ä¼šæ”¹å˜å›¾ç‰‡å®é™…å®½åº¦
  ;; å››ç§è®¾ç½®æ–¹æ³•ï¼š(1080), 1080, t, nil
  (org-image-actual-width nil)
  ;; imenuçš„æœ€å¤§æ·±åº¦ï¼Œé»˜è®¤ä¸º2
  (org-imenu-depth 4)
  ;; å›è½¦è¦ä¸è¦è§¦å‘é“¾æ¥ï¼Œè¿™é‡Œè®¾ç½®ä¸è§¦å‘
  (org-return-follows-link nil)
  ;; ä¸Šæ ‡^ä¸‹æ ‡_æ˜¯å¦éœ€è¦ç‰¹æ®Šå­—ç¬¦åŒ…è£¹ï¼Œè¿™é‡Œè®¾ç½®éœ€è¦ç”¨å¤§æ‹¬å·åŒ…è£¹
  (org-use-sub-superscripts '{})
  ;; å¤åˆ¶ç²˜è´´æ ‡é¢˜è¡Œçš„æ—¶å€™åˆ é™¤id
  (org-clone-delete-id t)
  ;; ç²˜è´´æ—¶è°ƒæ•´æ ‡é¢˜è¡Œçš„çº§åˆ«
  (org-yank-adjusted-subtrees t)

  ;; TOODçš„å…³é”®è¯è®¾ç½®ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„ç»„
  (org-todo-keywords '((sequence "TODO(t)" "HOLD(h!)" "WIP(i!)" "WAIT(w!)" "|" "DONE(d!)" "CANCELLED(c@/!)")
					   (sequence "REPORT(r)" "BUG(b)" "KNOWNCAUSE(k)" "|" "FIXED(f!)")))
  ;; TODOå…³é”®è¯çš„æ ·å¼è®¾ç½®
  (org-todo-keyword-faces '(("TODO"       :foreground "#7c7c75" :weight bold)
							("HOLD"       :foreground "#feb24c" :weight bold)
							("WIP"        :foreground "#0098dd" :weight bold)
							("WAIT"       :foreground "#9f7efe" :weight bold)
							("DONE"       :foreground "#50a14f" :weight bold)
							("CANCELLED"  :foreground "#ff6480" :weight bold)
							("REPORT"     :foreground "magenta" :weight bold)
							("BUG"        :foreground "red"     :weight bold)
							("KNOWNCAUSE" :foreground "yellow"  :weight bold)
							("FIXED"      :foreground "green"   :weight bold)))
  ;; å½“æ ‡é¢˜è¡ŒçŠ¶æ€å˜åŒ–æ—¶æ ‡ç­¾åŒæ­¥å‘ç”Ÿçš„å˜åŒ–
  ;; Moving a task to CANCELLED adds a CANCELLED tag
  ;; Moving a task to WAIT adds a WAIT tag
  ;; Moving a task to HOLD adds WAIT and HOLD tags
  ;; Moving a task to a done state removes WAIT and HOLD tags
  ;; Moving a task to TODO removes WAIT, CANCELLED, and HOLD tags
  ;; Moving a task to DONE removes WAIT, CANCELLED, and HOLD tags
  (org-todo-state-tags-triggers
   (quote (("CANCELLED" ("CANCELLED" . t))
		   ("WAIT" ("WAIT" . t))
		   ("HOLD" ("WAIT") ("HOLD" . t))
		   (done ("WAIT") ("HOLD"))
		   ("TODO" ("WAIT") ("CANCELLED") ("HOLD"))
		   ("DONE" ("WAIT") ("CANCELLED") ("HOLD")))))
  ;; ä½¿ç”¨ä¸“å®¶æ¨¡å¼é€‰æ‹©æ ‡é¢˜æ çŠ¶æ€
  (org-use-fast-todo-selection 'expert)
  ;; çˆ¶å­æ ‡é¢˜æ çŠ¶æ€æœ‰ä¾èµ–
  (org-enforce-todo-dependencies t)
  ;; æ ‡é¢˜æ å’Œä»»åŠ¡å¤é€‰æ¡†æœ‰ä¾èµ–
  (org-enforce-todo-checkbox-dependencies t)
  ;; ä¼˜å…ˆçº§æ ·å¼è®¾ç½®
  (org-priority-faces '((?A :foreground "red")
						(?B :foreground "orange")
						(?C :foreground "yellow")))
  ;; æ ‡é¢˜è¡Œå…¨å±€å±æ€§è®¾ç½®
  (org-global-properties '(("EFFORT_ALL" . "0:15 0:30 0:45 1:00 2:00 3:00 4:00 5:00 6:00 7:00 8:00")
						   ("APPT_WARNTIME_ALL" . "0 5 10 15 20 25 30 45 60")
						   ("RISK_ALL" . "Low Medium High")
						   ("STYLE_ALL" . "habit")))
  ;; Org columnsçš„é»˜è®¤æ ¼å¼
  (org-columns-default-format "%25ITEM %TODO %SCHEDULED %DEADLINE %3PRIORITY %TAGS %CLOCKSUM %EFFORT{:}")
  ;; å½“çŠ¶æ€ä»DONEæ”¹æˆå…¶ä»–çŠ¶æ€æ—¶ï¼Œç§»é™¤ CLOSED: [timestamp]
  (org-closed-keep-when-no-todo t)
  ;; DONEæ—¶åŠ ä¸Šæ—¶é—´æˆ³
  (org-log-done 'time)
  ;; é‡å¤æ‰§è¡Œæ—¶åŠ ä¸Šæ—¶é—´æˆ³
  (org-log-repeat 'time)
  ;; Deadlineä¿®æ”¹æ—¶åŠ ä¸Šä¸€æ¡è®°å½•
  (org-log-redeadline 'note)
  ;; Scheduleä¿®æ”¹æ—¶åŠ ä¸Šä¸€æ¡è®°å½•
  (org-log-reschedule 'note)
  ;; ä»¥æŠ½å±‰çš„æ–¹å¼è®°å½•
  (org-log-into-drawer t)
  ;; ç´§æ¥ç€æ ‡é¢˜è¡Œæˆ–è€…è®¡åˆ’/æˆªæ­¢æ—¶é—´æˆ³ååŠ ä¸Šè®°å½•æŠ½å±‰
  (org-log-state-notes-insert-after-drawers nil)

  ;; refileä½¿ç”¨ç¼“å­˜
  (org-refile-use-cache t)
  ;; refileçš„ç›®çš„åœ°ï¼Œè¿™é‡Œè®¾ç½®çš„æ˜¯agendaæ–‡ä»¶çš„æ‰€æœ‰æ ‡é¢˜
  (org-refile-targets '((org-agenda-files . (:maxlevel . 9))))
  ;; å°†æ–‡ä»¶ååŠ å…¥åˆ°è·¯å¾„
  (org-refile-use-outline-path 'file)
  ;; æ˜¯å¦æŒ‰æ­¥éª¤refile
  (org-outline-path-complete-in-steps nil)
  ;; å…è®¸åˆ›å»ºæ–°çš„æ ‡é¢˜è¡Œï¼Œä½†éœ€è¦ç¡®è®¤
  (org-refile-allow-creating-parent-nodes 'confirm)

  ;; è®¾ç½®æ ‡ç­¾çš„é»˜è®¤ä½ç½®ï¼Œé»˜è®¤æ˜¯ç¬¬77åˆ—å³å¯¹é½
  ;; (org-tags-column -77)
  ;; è‡ªåŠ¨å¯¹é½æ ‡ç­¾
  (org-auto-align-tags t)
  ;; æ ‡ç­¾ä¸ç»§æ‰¿
  (org-use-tag-inheritance nil)
  ;; åœ¨æ—¥ç¨‹è§†å›¾çš„æ ‡ç­¾ä¸ç»§æ‰¿
  (org-agenda-use-tag-inheritance nil)
  ;; æ ‡ç­¾å¿«é€Ÿé€‰æ‹©
  (org-use-fast-tag-selection t)
  ;; æ ‡ç­¾é€‰æ‹©ä¸éœ€è¦å›è½¦ç¡®è®¤
  (org-fast-tag-selection-single-key t)
  ;; å®šä¹‰äº†æœ‰åºå±æ€§çš„æ ‡é¢˜è¡Œä¹ŸåŠ ä¸Š OREDERD æ ‡ç­¾
  (org-track-ordered-property-with-tag t)
  ;; å§‹ç»ˆå­˜åœ¨çš„çš„æ ‡ç­¾
  (org-tag-persistent-alist '(("read"     . ?r)
							  ("mail"     . ?m)
							  ("emacs"    . ?e)
							  ("study"    . ?s)
							  ("work"     . ?w)))
  ;; é¢„å®šä¹‰å¥½çš„æ ‡ç­¾
  (org-tag-alist '((:startgroup)
				   ("crypt"    . ?c)
				   ("linux"    . ?l)
				   ("apple"    . ?a)
				   ("noexport" . ?n)
				   ("ignore"   . ?i)
				   ("toc"      . ?t)
				   (:endgroup)))

  ;; å½’æ¡£è®¾ç½®
  (org-archive-location "%s_archive::datetree/")
  )

;; Org modeçš„é™„åŠ åŒ…ï¼Œæœ‰è¯¸å¤šé™„åŠ åŠŸèƒ½
(use-package org-contrib
  :ensure t)
#+END_SRC

** org-modern ç¾åŒ–
ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ [[https://github.com/minad/org-modern][org-modern]] æ’ä»¶å¯¹Org modeè¿›è¡Œè¿›ä¸€æ­¥çš„ç¾åŒ–ã€‚

#+BEGIN_SRC emacs-lisp
(use-package org-modern
  :ensure t
  :hook (after-init . (lambda ()
                        (setq org-modern-hide-stars 'leading)
                        (global-org-modern-mode t)))
  :config
  ;; æ ‡é¢˜è¡Œå‹å·å­—ç¬¦
  (setq org-modern-star ["â—‰" "â—‹" "âœ¸" "âœ³" "â—ˆ" "â—‡" "âœ¿" "â€" "âœœ"])
  ;; é¢å¤–çš„è¡Œé—´è·ï¼Œ0.1è¡¨ç¤º10%ï¼Œ1è¡¨ç¤º1px
  (setq-default line-spacing 0.1)
  ;; tagè¾¹æ¡†å®½åº¦ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¸º `auto' å³è‡ªåŠ¨è®¡ç®—
  (setq org-modern-label-border 1)
  ;; è®¾ç½®è¡¨æ ¼ç«–çº¿å®½åº¦ï¼Œé»˜è®¤ä¸º3
  (setq org-modern-table-vertical 2)
  ;; è®¾ç½®è¡¨æ ¼æ¨ªçº¿ä¸º0ï¼Œé»˜è®¤ä¸º0.1
  (setq org-modern-table-horizontal 0)
  ;; å¤é€‰æ¡†ç¾åŒ–
  (setq org-modern-checkbox
        '((?X . #("â–¢âœ“" 0 2 (composition ((2)))))
          (?- . #("â–¢â€“" 0 2 (composition ((2)))))
          (?\s . #("â–¢" 0 1 (composition ((1)))))))
  ;; åˆ—è¡¨ç¬¦å·ç¾åŒ–
  (setq org-modern-list
        '((?- . "â€¢")
          (?+ . "â—¦")
          (?* . "â–¹")))
  ;; ä»£ç å—å·¦è¾¹åŠ ä¸Šä¸€æ¡ç«–è¾¹çº¿ï¼ˆéœ€è¦Org modeé¡¶å¤´ï¼Œå¦‚æœå¯ç”¨äº† `visual-fill-column-mode' ä¼šå¾ˆéš¾çœ‹ï¼‰
  (setq org-modern-block-fringe t)
  ;; ä»£ç å—ç±»å‹ç¾åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `prettify-symbols-mode'
  (setq org-modern-block-name nil)
  ;; #+å…³é”®å­—ç¾åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `prettify-symbols-mode'
  (setq org-modern-keyword nil)
  )
#+END_SRC

** org-appearè‡ªåŠ¨å±•å¼€å¼ºè°ƒé“¾æ¥

é€šè¿‡ [[https://github.com/awth13/org-appear][org-appear]] æ’ä»¶ï¼Œå½“æˆ‘ä»¬çš„å…‰æ ‡ç§»åŠ¨åˆ°Org modeé‡Œçš„å¼ºè°ƒã€é“¾æ¥ä¸Šæ—¶ï¼Œä¼šè‡ªåŠ¨å±•å¼€ï¼Œè¿™æ ·æ–¹ä¾¿è¿›è¡Œç¼–è¾‘ã€‚

#+begin_src emacs-lisp
(use-package org-appear
  :ensure t
  :hook (org-mode . org-appear-mode)
  :config
  (setq org-appear-autolinks t)
  (setq org-appear-autosubmarkers t)
  (setq org-appear-autoentities t)
  (setq org-appear-autokeywords t)
  (setq org-appear-inside-latex t)
  )
#+end_src

** org-auto-tangleè‡ªåŠ¨tangleè®¾ç½®

[[https://github.com/yilkalargaw/org-auto-tangle][org-auto-tangle]] æ’ä»¶å¯ä»¥åœ¨Org modeä¸‹è‡ªåŠ¨è¿›è¡Œtangleã€‚

#+BEGIN_SRC emacs-lisp
(use-package org-auto-tangle
  :ensure t
  :hook (org-mode . org-auto-tangle-mode)
  :config
  (setq org-auto-tangle-default t)
  )
#+END_SRC

** org-captureå¿«é€Ÿè®°å½•è®¾ç½®

#+BEGIN_SRC emacs-lisp
(use-package org-capture
  :ensure nil
  :bind ("\e\e c" . (lambda () (interactive) (org-capture)))
  :hook ((org-capture-mode . (lambda ()
                               (setq-local org-complete-tags-always-offer-all-agenda-tags t)))
         (org-capture-mode . delete-other-windows))
  :custom
  (org-capture-use-agenda-date nil)
  ;; define common template
  (org-capture-templates `(("t" "Tasks" entry (file+headline "tasks.org" "Reminders")
                            "* TODO %i%?"
                            :empty-lines-after 1
                            :prepend t)
                           ("n" "Notes" entry (file+headline "capture.org" "Notes")
                            "* %? %^g\n%i\n"
                            :empty-lines-after 1)
                           ;; For EWW
                           ("b" "Bookmarks" entry (file+headline "capture.org" "Bookmarks")
                            "* %:description\n\n%a%?"
                            :empty-lines 1
                            :immediate-finish t)
                           ("d" "Diary")
                           ("dt" "Today's TODO list" entry (file+olp+datetree "diary.org")
                            "* Today's TODO list [/]\n%T\n\n** TODO %?"
                            :empty-lines 1
                            :jump-to-captured t)
                           ("do" "Other stuff" entry (file+olp+datetree "diary.org")
                            "* %?\n%T\n\n%i"
                            :empty-lines 1
                            :jump-to-captured t)
                           ))
  )
#+END_SRC

** denoteç¬”è®°è®¾ç½®

[[https://protesilaos.com/emacs/denote][denote]] æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ç¬”è®°æ’ä»¶ï¼Œæ‹¥æœ‰è‰¯å¥½çš„æ–‡ä»¶åå‘½åæ¨¡æ¿ã€‚

#+BEGIN_SRC emacs-lisp
(use-package denote
  :ensure t
  :hook (dired-mode . denote-dired-mode-in-directories)
  :bind (("C-c d n" . denote)
         ("C-c d d" . denote-date)
         ("C-c d t" . denote-type)
         ("C-c d s" . denote-subdirectory)
         ("C-c d f" . denote-open-or-create)
         ("C-c d r" . denote-dired-rename-file))
  :init
  (with-eval-after-load 'org-capture
    (setq denote-org-capture-specifiers "%l\n%i\n%?")
    (add-to-list 'org-capture-templates
                 '("N" "New note (with denote.el)" plain
                   (file denote-last-path)
                   #'denote-org-capture
                   :no-save t
                   :immediate-finish nil
                   :kill-buffer t
                   :jump-to-captured t)))
  :config
  (setq denote-directory (expand-file-name "~/org/"))
  (setq denote-known-keywords '("emacs" "entertainment" "reading" "studying"))
  (setq denote-infer-keywords t)
  (setq denote-sort-keywords t)
  ;; org is default, set others such as text, markdown-yaml, markdown-toml
  (setq denote-file-type nil)
  (setq denote-prompts '(title keywords))

  ;; We allow multi-word keywords by default.  The author's personal
  ;; preference is for single-word keywords for a more rigid workflow.
  (setq denote-allow-multi-word-keywords t)
  (setq denote-date-format nil)

  ;; If you use Markdown or plain text files (Org renders links as buttons
  ;; right away)
  (add-hook 'find-file-hook #'denote-link-buttonize-buffer)
  (setq denote-dired-rename-expert nil)

  ;; OR if only want it in `denote-dired-directories':
  (add-hook 'dired-mode-hook #'denote-dired-mode-in-directories)
  )
#+END_SRC

** consult-notesæŸ¥æ‰¾ç¬”è®°

[[https://github.com/mclear-tools/consult-notes][consult-notes]] æ’ä»¶å¯ä»¥é€šè¿‡consultå¿«é€Ÿæ‰¾åˆ°ç¬”è®°ã€‚

#+BEGIN_SRC emacs-lisp
(use-package consult-notes
  :ensure t
  :commands (consult-notes
             consult-notes-search-in-all-notes)
  :bind (("C-c n f" . consult-notes)
         ("C-c n c" . consult-notes-search-in-all-notes))
  :config
  (setq consult-notes-file-dir-sources
        `(
          ("work"    ?w ,(concat org-directory "/midea/"))
          ("article" ?a ,(concat org-directory "/article/"))
          ("org"     ?o ,(concat org-directory "/"))
          ("hugo"    ?h ,(concat org-directory "/hugo/"))
          ("books"   ?b ,(concat (getenv "HOME") "/Books/"))
          ))

  ;; embark support
  (with-eval-after-load 'embark
    (defun consult-notes-open-dired (cand)
      "Open notes directory dired with point on file CAND."
      (interactive "fNote: ")
      ;; dired-jump is in dired-x.el but is moved to dired in Emacs 28
      (dired-jump nil cand))

    (defun consult-notes-marked (cand)
      "Open a notes file CAND in Marked 2.
Marked 2 is a mac app that renders markdown."
      (interactive "fNote: ")
      (call-process-shell-command (format "open -a \"Marked 2\" \"%s\"" (expand-file-name cand))))

    (defun consult-notes-grep (cand)
      "Run grep in directory of notes file CAND."
      (interactive "fNote: ")
      (consult-grep (file-name-directory cand)))

    (embark-define-keymap consult-notes-map
                          "Keymap for Embark notes actions."
                          :parent embark-file-map
                          ("d" consult-notes-dired)
                          ("g" consult-notes-grep)
                          ("m" consult-notes-marked))

    (add-to-list 'embark-keymap-alist `(,consult-notes-category . consult-notes-map))

    ;; make embark-export use dired for notes
    (setf (alist-get consult-notes-category embark-exporters-alist) #'embark-export-dired)
    )
  )
#+END_SRC

** org-super-linksåé“¾è®¾ç½®

[[https://github.com/toshism/org-super-links][org-super-links]] æ’ä»¶å¯ä»¥è®¾ç½®åå‘é“¾æ¥ã€‚

#+BEGIN_SRC emacs-lisp
(use-package org-super-links
  :quelpa (org-super-links :fetcher github :repo "toshism/org-super-links")
  :bind (("C-c s s"   . org-super-links-link)
         ("C-c s l"   . org-super-links-store-link)
         ("C-c s C-l" . org-super-links-insert-link)
         ("C-c s d"   . org-super-links-quick-insert-drawer-link)
         ("C-c s i"   . org-super-links-quick-insert-inline-link)
         ("C-c s C-d" . org-super-links-delete-link))
  :config
  (setq org-super-links-related-into-drawer t)
  (setq	org-super-links-link-prefix 'org-super-links-link-prefix-timestamp))
#+END_SRC

** org-srcä»£ç å—åŸºç¡€é…ç½®

Org modeä»£ç å—çš„åŸºæœ¬é…ç½®ã€‚

#+BEGIN_SRC emacs-lisp
(use-package org-src
  :ensure nil
  :hook (org-babel-after-execute . org-redisplay-inline-images)
  :bind (("s-l" . show-line-number-in-src-block)
         :map org-src-mode-map
         ("C-c C-c" . org-edit-src-exit))
  :init
  ;; è®¾ç½®ä»£ç å—çš„é»˜è®¤å¤´å‚æ•°
  (setq org-babel-default-header-args
        '(
          (:eval    . "never-export")     ; å¯¼å‡ºæ—¶ä¸æ‰§è¡Œä»£ç å—
          (:session . "none")
          (:results . "replace")          ; æ‰§è¡Œç»“æœæ›¿æ¢
          (:exports . "both")             ; å¯¼å‡ºä»£ç å’Œç»“æœ
          (:cache   . "no")
          (:noweb   . "no")
          (:hlines  . "no")
          (:wrap    . "results")          ; ç»“æœé€šè¿‡#+begin_resultsåŒ…è£¹
          (:tangle  . "no")               ; ä¸å†™å…¥æ–‡ä»¶
          ))
  :config
  ;; ==================================
  ;; å¦‚æœå‡ºç°ä»£ç è¿è¡Œç»“æœä¸ºä¹±ç ï¼Œå¯ä»¥å‚è€ƒï¼š
  ;; https://github.com/nnicandro/emacs-jupyter/issues/366
  ;; ==================================
  (defun display-ansi-colors ()
    (ansi-color-apply-on-region (point-min) (point-max)))
  (add-hook 'org-babel-after-execute-hook #'display-ansi-colors)

  ;; ==============================================
  ;; é€šè¿‡overlayåœ¨ä»£ç å—é‡Œæ˜¾ç¤ºè¡Œå·ï¼Œs-læ˜¾ç¤ºï¼Œä»»æ„é”®å…³é—­
  ;; ==============================================
  (defvar number-line-overlays '()
    "List of overlays for line numbers.")

  (defun show-line-number-in-src-block ()
    (interactive)
    (save-excursion
      (let* ((src-block (org-element-context))
             (nlines (- (length
                         (s-split
                          "\n"
                          (org-element-property :value src-block)))
                        1)))
        (goto-char (org-element-property :begin src-block))
        (re-search-forward (regexp-quote (org-element-property :value src-block)))
        (goto-char (match-beginning 0))

        (cl-loop for i from 1 to nlines
                 do
                 (beginning-of-line)
                 (let (ov)
                   (setq ov (make-overlay (point) (point)))
                   (overlay-put ov 'before-string (format "%3s | " (number-to-string i)))
                   (add-to-list 'number-line-overlays ov))
                 (next-line))))

    ;; now read a char to clear them
    (read-key "Press a key to clear numbers.")
    (mapc 'delete-overlay number-line-overlays)
    (setq number-line-overlays '()))

  ;; =================================================
  ;; æ‰§è¡Œç»“æœåï¼Œå¦‚æœç»“æœæ‰€åœ¨çš„æ–‡ä»¶å¤¹ä¸å­˜åœ¨å°†è‡ªåŠ¨åˆ›å»º
  ;; =================================================
  (defun check-directory-exists-before-src-execution (orig-fun
                                                      &optional arg
                                                      info
                                                      params)
    (when (and (assq ':file (cadr (cdr (org-babel-get-src-block-info))))
               (member (car (org-babel-get-src-block-info)) '("mermaid" "ditaa" "dot" "lilypond" "plantuml" "gnuplot" "d2")))
      (let ((foldername (file-name-directory (alist-get :file (nth 2 (org-babel-get-src-block-info))))))
        (if (not (file-exists-p foldername))
            (mkdir foldername)))))
  (advice-add 'org-babel-execute-src-block :before #'check-directory-exists-before-src-execution)

  ;; =================================================
  ;; è‡ªåŠ¨ç»™ç»“æœçš„å›¾ç‰‡åŠ ä¸Šç›¸å…³å±æ€§
  ;; =================================================
  (setq original-image-width-before-del "400") ; è®¾ç½®å›¾ç‰‡çš„é»˜è®¤å®½åº¦ä¸º400
  (setq original-caption-before-del "")        ; è®¾ç½®é»˜è®¤çš„å›¾ç¤ºæ–‡æœ¬ä¸ºç©º

  (defun insert-attr-decls ()
    "insert string before babel execution results"
    (insert (concat "\n#+CAPTION:"
                    original-caption-before-del
                    "\n#+ATTR_ORG: :width "
                    original-image-width-before-del
                    "\n#+ATTR_LATEX: :width "
                    (if (>= (/ (string-to-number original-image-width-before-del) 800.0) 1)
                        "1.0"
                      (number-to-string (/ (string-to-number original-image-width-before-del) 800.0)))
                    "\\linewidth :float nil"
                    "\n#+ATTR_HTML: :width "
                    original-image-width-before-del
                    )))

  (defun insert-attr-decls-at (s)
    "insert string right after specific string"
    (let ((case-fold-search t))
      (if (search-forward s nil t)
          (progn
            ;; (search-backward s nil t)
            (insert-attr-decls)))))

  (defun insert-attr-decls-at-results (orig-fun
                                       &optional arg
                                       info
                                       param)
    "insert extra image attributes after babel execution"
    (interactive)
    (progn
      (when (member (car (org-babel-get-src-block-info)) '("mermaid" "ditaa" "dot" "lilypond" "plantuml" "gnuplot" "d2"))
        (setq original-image-width-before-del (number-to-string (if-let* ((babel-width (alist-get :width (nth 2 (org-babel-get-src-block-info))))) babel-width (string-to-number original-image-width-before-del))))
        (save-excursion
          ;; `#+begin_results' for :wrap results, `#+RESULTS:' for non :wrap results
          (insert-attr-decls-at "#+begin_results")))
      (org-redisplay-inline-images)))
  (advice-add 'org-babel-execute-src-block :after #'insert-attr-decls-at-results)

  ;; å†æ¬¡æ‰§è¡Œæ—¶éœ€è¦å°†æ—§çš„å›¾ç‰‡ç›¸å…³å‚æ•°è¡Œåˆ é™¤ï¼Œå¹¶ä»ä¸­å¤´å‚æ•°ä¸­è·å¾—å®½åº¦å‚æ•°ï¼Œå‚è€ƒ
  ;; https://emacs.stackexchange.com/questions/57710/how-to-set-image-size-in-result-of-src-block-in-org-mode
  (defun get-attributes-from-src-block-result (&rest args)
    "get information via last babel execution"
    (let ((location (org-babel-where-is-src-block-result))
          ;; ä¸»è¦è·å–çš„æ˜¯å›¾ç¤ºæ–‡å­—å’Œå®½åº¦ä¿¡æ¯ï¼Œä¸‹é¢è¿™ä¸ªæ­£åˆ™å°±æ˜¯ä¸ºäº†æ•è·è¿™ä¸¤ä¸ªä¿¡æ¯
          (attr-regexp "[:blank:]*#\\+\\(ATTR_ORG: :width \\([0-9]\\{3\\}\\)\\|CAPTION:\\(.*\\)\\)"))
      (setq original-caption-before-del "") ; é‡ç½®ä¸ºç©º
      (when location
        (save-excursion
          (goto-char location)
          (when (looking-at (concat org-babel-result-regexp ".*$"))
            (next-line 2)               ; å› ä¸ºæœ‰ä¸ªbegin_resultçš„æŠ½å±‰ï¼Œæ‰€ä»¥å¾€ä¸‹2è¡Œ
            ;; é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥æ•è·éœ€è¦çš„ä¿¡æ¯
            (while (looking-at attr-regexp)
              (when (match-string 2)
                (setq original-image-width-before-del (match-string 2)))
              (when (match-string 3)
                (setq original-caption-before-del (match-string 3)))
              (next-line)               ; å› ä¸ºè®¾ç½®äº†:wrapï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦åˆ é™¤è¿™ä¸€è¡Œ
              )
            )))))
  (advice-add 'org-babel-execute-src-block :before #'get-attributes-from-src-block-result)

  :custom
  ;; ä»£ç å—è¯­æ³•é«˜äº®
  (org-src-fontify-natively t)
  ;; ä½¿ç”¨ç¼–ç¨‹è¯­è¨€çš„TABç»‘å®šè®¾ç½®
  (org-src-tab-acts-natively t)
  ;; ä¿ç•™ä»£ç å—å‰é¢çš„ç©ºæ ¼
  (org-src-preserve-indentation t)
  ;; ä»£ç å—ç¼–è¾‘çª—å£çš„æ‰“å¼€æ–¹å¼ï¼šå½“å‰çª—å£+ä»£ç å—ç¼–è¾‘çª—å£
  (org-src-window-setup 'reorganize-frame)
  ;; æ‰§è¡Œå‰æ˜¯å¦éœ€è¦ç¡®è®¤
  (org-confirm-babel-evaluate nil)
  ;; ä»£ç å—é»˜è®¤å‰ç½®å¤šå°‘ç©ºæ ¼
  (org-edit-src-content-indentation 0)
  ;; ä»£ç å—çš„è¯­è¨€æ¨¡å¼è®¾ç½®ï¼Œè®¾ç½®ä¹‹åæ‰èƒ½æ­£ç¡®è¯­æ³•é«˜äº®
  (org-src-lang-modes '(("C"            . c)
                        ("C++"          . c++)
                        ("bash"         . sh)
                        ("cpp"          . c++)
                        ("elisp"        . emacs-lisp)
                        ("python"       . python)
                        ("shell"        . sh)
                        ("mysql"        . sql)
                        ))
  ;; åœ¨è¿™ä¸ªé˜¶æ®µï¼Œåªéœ€è¦åŠ è½½é»˜è®¤æ”¯æŒçš„è¯­è¨€
  (org-babel-load-languages '((python          . t)
                              (awk             . t)
                              (C               . t)
                              (calc            . t)
                              (emacs-lisp      . t)
                              (eshell          . t)
                              (shell           . t)
                              (sql             . t)
                              (css             . t)
                              ))
  )
#+END_SRC

** org babelä»£ç å—åç«¯
*** plantumlç»˜å›¾
[[https://plantuml.com/zh/][plantuml]] å¯ä»¥è®©æˆ‘ä»¬åœ¨Org modeé‡Œé€šè¿‡çº¯æ–‡æœ¬ç”»å„ç§å›¾ï¼Œå…·ä½“å‚è€ƒï¼š[[https://plantuml.com/zh/emacs][PlantUML integration with Emacs]]ã€‚

éœ€è¦æå‰é€šè¿‡ =brew install plantuml= å®‰è£… =plantuml= ã€‚

#+BEGIN_SRC emacs-lisp
(use-package plantuml-mode
  :ensure t
  :mode ("\\.plantuml\\'" . plantuml-mode)
  :init
  ;; enable plantuml babel support
  (add-to-list 'org-src-lang-modes '("plantuml" . plantuml))
  (org-babel-do-load-languages 'org-babel-load-languages
                               (append org-babel-load-languages
                                       '((plantuml . t))))
  :config
  (setq org-plantuml-exec-mode 'plantuml)
  (setq org-plantuml-executable-path "plantuml")
  (setq plantuml-executable-path "plantuml")
  (setq plantuml-default-exec-mode 'executable)
  ;; set default babel header arguments
  (setq org-babel-default-header-args:plantuml
        '((:exports . "results")
          (:results . "file")
          ))
  )
#+END_SRC

*** gnuplotç»˜å›¾

[[https://github.com/emacs-gnuplot/gnuplot][gnuplot]] æ’ä»¶å¯ä»¥è®©Emacsé€šè¿‡gnuplotç»˜å›¾ã€‚

#+BEGIN_SRC emacs-lisp
(use-package gnuplot
  :ensure t
  :mode ("\\.gp$" . gnuplot-mode)
  :init
  (add-to-list 'org-src-lang-modes '("gnuplot" . gnuplot))
  (org-babel-do-load-languages 'org-babel-load-languages
                               (append org-babel-load-languages
                                       '((gnuplot . t))))
  :config
  ;; (add-to-list 'auto-mode-alist '("\\.gp$" . gnuplot-mode))
  (setq org-babel-default-header-args:gnuplot
      '((:exports . "results")
        (:results . "file")))
  )
#+END_SRC

*** lilypondä¹è°±ç»˜å›¾

é€šè¿‡ =lilypond= ä¹è°±ç”»å›¾ï¼Œéœ€è¦æå‰å®‰è£… =lilypond= å’Œ =mactex-no-gui= ã€‚

#+BEGIN_SRC emacs-lisp
(use-package lilypond-mode
  :ensure nil
  :mode ("\\.i?ly\\'" . LilyPond-mode)
  :init
  (add-to-list 'org-src-lang-modes '("lilypond" . lilypond))
  ;; add support for org babel
  (org-babel-do-load-languages 'org-babel-load-languages
                               (append org-babel-load-languages
                                       '((lilypond . t))))
  ;; set lilypond binary directory
  (setq org-babel-lilypond-ly-command "/usr/local/bin/lilypond -dpreview")
  :config
  ;; ;; trim extra space for generated image
  ;; (defun my/trim-lilypond-png (orig-fun
  ;;                              &optional arg
  ;;                              info
  ;;                              param)
  ;;   (when (member (car (org-babel-get-src-block-info)) '("lilypond"))
  ;;     (let ((ly-file (alist-get :file (nth 2 (org-babel-get-src-block-info)))))
  ;;       (let ((ly-preview-file (replace-regexp-in-string "\\.png" ".preview.png" ly-file)))
  ;;         (when (file-exists-p ly-preview-file)
  ;;           (shell-command (concat "mv " ly-preview-file " " ly-file)))
  ;;         (org-redisplay-inline-images)))))
  ;; (advice-add 'org-babel-execute-src-block :after #'my/trim-lilypond-png)
  (setq ob-lilypond-header-args
        '((:results . "file replace")
          (:exports . "results")
          ))
  )
#+END_SRC

** é™åˆ¶ä»£ç å—ç»“æœé•¿åº¦

å‚è€ƒ [[https://emacs-china.org/t/org-babel/18399/4][twlz0ne å¤§ä½¬åœ¨è¿™ç¯‡è´´å­çš„å›å¤]]ã€‚

#+BEGIN_SRC emacs-lisp
;; limit the babel result length
(defvar org-babel-result-lines-limit 40)
(defvar org-babel-result-length-limit 6000)

(defun org-babel-insert-result@limit (orig-fn result &rest args)
  (if (not (member (car (org-babel-get-src-block-info)) '("jupyter-python"))) ; not for jupyter-python etc.
    (if (and result (or org-babel-result-lines-limit org-babel-result-length-limit))
        (let (new-result plines plenght limit)
          (with-temp-buffer
            (insert result)
            (setq plines (if org-babel-result-lines-limit
                             (goto-line org-babel-result-lines-limit)
                           (point-max)))
            (setq plenght (if org-babel-result-length-limit
                              (min org-babel-result-length-limit (point-max))
                            (point-max)))
            (setq limit (min plines plenght))
            (setq new-result (concat (buffer-substring (point-min) limit)
                                     (if (< limit (point-max)) "..."))))
          (apply orig-fn new-result args))
      (apply orig-fn result args))
    (apply orig-fn result args)))

(advice-add 'org-babel-insert-result :around #'org-babel-insert-result@limit)
#+END_SRC

** oxæ–‡ä»¶å¯¼å‡ºé€šç”¨è®¾ç½®

ä¸‹é¢æ˜¯orgæ–‡ä»¶å¯¼å‡ºçš„é€šç”¨è®¾ç½®ã€‚

#+begin_src emacs-lisp
(use-package ox
  :ensure nil
  :custom
  (org-export-with-toc t)
  (org-export-with-tags 'not-in-toc)
  (org-export-with-drawers nil)
  (org-export-with-priority t)
  (org-export-with-footnotes t)
  (org-export-with-smart-quotes t)
  (org-export-with-section-numbers t)
  (org-export-with-sub-superscripts '{})
  ;; `org-export-use-babel' set to nil will cause all source block header arguments to be ignored This means that code blocks with the argument :exports none or :exports results will end up in the export.
  ;; See:
  ;; https://stackoverflow.com/questions/29952543/how-do-i-prevent-org-mode-from-executing-all-of-the-babel-source-blocks
  (org-export-use-babel t)
  (org-export-headline-levels 9)
  (org-export-coding-system 'utf-8)
  (org-export-with-broken-links 'mark)
  (org-export-default-language "zh-CN") ; é»˜è®¤æ˜¯en
  ;; (org-ascii-text-width 72)
  )

;; export extra
(use-package ox-extra
  :ensure nil
  :config
  (ox-extras-activate '(ignore-headlines))
  )
#+end_src

** orgå¯¼å‡ºåç«¯è®¾ç½®
*** ox-htmlå¯¼å‡ºHTMLè®¾ç½®

æˆ‘ä»¬å…ˆæ¥å¯¹HTMLå¯¼å‡ºåšä¸€ä¸ªåŸºæœ¬è®¾ç½®ï¼š

#+BEGIN_SRC emacs-lisp
(use-package ox-html
  :ensure nil
  :init
  ;; add support for video
  (defun org-video-link-export (path desc backend)
    (let ((ext (file-name-extension path)))
      (cond
       ((eq 'html backend)
        (format "<video width='800' preload='metadata' controls='controls'><source type='video/%s' src='%s' /></video>" ext path))
       ;; fall-through case for everything else
       (t
        path))))
  (org-link-set-parameters "video" :export 'org-video-link-export)
  :custom
  (org-html-doctype "html5")
  (org-html-html5-fancy t)
  (org-html-checkbox-type 'unicode)
  (org-html-validation-link nil))

(use-package htmlize
  :ensure t
  :custom
  (htmlize-pre-style t)
  (htmlize-output-type 'inline-css))
#+END_SRC

*** ox-latexå¯¼å‡ºPDFè®¾ç½®

=ox-latex= æ˜¯Org modeè‡ªå¸¦çš„åŠŸèƒ½ï¼Œå¯ä»¥å°†Orgæ–‡ä»¶å¯¼å‡ºä¸ºlatexæ–‡ä»¶å’ŒPDFæ–‡ä»¶ã€‚

#+BEGIN_SRC emacs-lisp
(use-package ox-latex
  :ensure nil
  :defer t
  :config
  (add-to-list 'org-latex-classes
               '("cn-article"
                 "\\documentclass[UTF8,a4paper]{article}"
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

  (add-to-list 'org-latex-classes
               '("cn-report"
                 "\\documentclass[11pt,a4paper]{report}"
                 ("\\chapter{%s}" . "\\chapter*{%s}")
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")))
  (setq org-latex-default-class "cn-article")
  (setq org-latex-image-default-height "0.9\\textheight"
        org-latex-image-default-width "\\linewidth")
  (setq org-latex-pdf-process
	    '("xelatex -interaction nonstopmode -output-directory %o %f"
	      "bibtex %b"
	      "xelatex -interaction nonstopmode -output-directory %o %f"
	      "xelatex -interaction nonstopmode -output-directory %o %f"
	      "rm -fr %b.out %b.log %b.tex %b.brf %b.bbl auto"
	      ))
  ;; ä½¿ç”¨ Listings å®åŒ…æ ¼å¼åŒ–æºä»£ç (åªæ˜¯æŠŠä»£ç æ¡†ç”¨ listing ç¯å¢ƒæ¡†èµ·æ¥ï¼Œè¿˜éœ€è¦é¢å¤–çš„è®¾ç½®)
  (setq org-latex-listings t)
  ;; mapping jupyter-python to Python
  (add-to-list 'org-latex-listings-langs '(jupyter-python "Python"))
  ;; Options for \lset commandï¼ˆreference to listing Manual)
  (setq org-latex-listings-options
        '(
          ("basicstyle" "\\small\\ttfamily")       ; æºä»£ç å­—ä½“æ ·å¼
          ("keywordstyle" "\\color{eminence}\\small")                 ; å…³é”®è¯å­—ä½“æ ·å¼
          ;; ("identifierstyle" "\\color{doc}\\small")
          ("commentstyle" "\\color{commentgreen}\\small\\itshape")    ; æ‰¹æ³¨æ ·å¼
          ("stringstyle" "\\color{red}\\small")                       ; å­—ç¬¦ä¸²æ ·å¼
          ("showstringspaces" "false")                                ; å­—ç¬¦ä¸²ç©ºæ ¼æ˜¾ç¤º
          ("numbers" "left")                                          ; è¡Œå·æ˜¾ç¤º
          ("numberstyle" "\\color{preprocess}")                       ; è¡Œå·æ ·å¼
          ("stepnumber" "1")                                          ; è¡Œå·é€’å¢
          ("xleftmargin" "2em")                                       ;
          ;; ("backgroundcolor" "\\color{background}")                   ; ä»£ç æ¡†èƒŒæ™¯è‰²
          ("tabsize" "4")                                             ; TAB ç­‰æ•ˆç©ºæ ¼æ•°
          ("captionpos" "t")                                          ; æ ‡é¢˜ä½ç½® top or buttom(t|b)
          ("breaklines" "true")                                       ; è‡ªåŠ¨æ–­è¡Œ
          ("breakatwhitespace" "true")                                ; åªåœ¨ç©ºæ ¼åˆ†è¡Œ
          ("showspaces" "false")                                      ; æ˜¾ç¤ºç©ºæ ¼
          ("columns" "flexible")                                      ; åˆ—æ ·å¼
          ("frame" "tb")                                              ; ä»£ç æ¡†ï¼šsingle, or tb ä¸Šä¸‹çº¿
          ("frameleftmargin" "1.5em")                                 ; frame å‘å³åç§»
          ;; ("frameround" "tttt")                                       ; ä»£ç æ¡†ï¼š åœ†è§’
          ;; ("framesep" "0pt")
          ;; ("framerule" "1pt")                                         ; æ¡†çš„çº¿å®½
          ;; ("rulecolor" "\\color{background}")                         ; æ¡†é¢œè‰²
          ;; ("fillcolor" "\\color{white}")
          ;; ("rulesepcolor" "\\color{comdil}")
          ("framexleftmargin" "5mm")                                  ; let line numer inside frame
          ))
  )
#+END_SRC

*** ox-revealå¯¼å‡ºå¹»ç¯ç‰‡è®¾ç½®

æˆ‘ä»¬å¯ä»¥ [[https://github.com/hexmode/ox-reveal][ox-reveal]] æ’ä»¶ï¼Œå°†orgæ–‡ä»¶å¯¼å‡ºä¸ºæ¼‚äº®çš„å¹»ç¯ç‰‡ã€‚éœ€è¦æå‰ [[https://revealjs.com/installation/][å®‰è£…reveal.js]]ï¼š

1. å…‹éš† =reveal.js= é¡¹ç›®
   #+BEGIN_SRC shell :tangle no
cd ~/.emacs.d/ && git clone https://github.com/hakimel/reveal.js.git
   #+END_SRC
2. å®‰è£…ä¾èµ–
   #+BEGIN_SRC shell :tangle no
cd reveal.js && npm install
   #+END_SRC

#+begin_src emacs-lisp
(use-package ox-reveal
  :ensure t
  :after ox
  :config
  (setq org-reveal-hlevel 1)
  ;; Avalable themes: night, black, white, league, beige, sky, serif, simple, solarized, blood, moon
  (setq org-reveal-theme "moon")
  ;; can also set root to a CDN cloud: https://cdn.jsdelivr.net/npm/reveal.js
  (setq org-reveal-root (expand-file-name "reveal.js" user-emacs-directory))
  (setq org-reveal-mathjax t)
  (setq org-reveal-ignore-speaker-notes t)
  ;; original title font size is TOO large!
  (setq org-reveal-title-slide "<h1><font size=\"8\">%t</font></h1><h2><font size=\"6\">%s</font></h2><p><font size=\"5\">%a</font><br/><font size=\"5\">%d</font></p>")
  ;; don't load highlight, use htmlize instead. If you want to add line-number, add -n in src block header
  (setq org-reveal-plugins '(markdown zoom notes search))
  (setq org-reveal-klipsify-src 'on)
  (setq org-reveal-extra-css (expand-file-name "reveal.js/css/extra.css" user-emacs-directory))
  )
#+end_src

*** ox-gfmå¯¼å‡ºMarkdownè®¾ç½®

æˆ‘ä»¬é€šè¿‡ [[https://github.com/larstvei/ox-gfm][ox-gfm]] æ’ä»¶æ¥å¯¼å‡ºGithubæ ·å¼çš„Markdownæ–‡ä»¶ã€‚

#+BEGIN_SRC emacs-lisp
(use-package ox-gfm
  :ensure t
  :after ox)
#+END_SRC

*** ox-pandocå¯¼å‡ºå„ç§æ ¼å¼è®¾ç½®

[[https://github.com/kawabata/ox-pandoc][ox-pandoc]] å¯ä»¥å°†orgæ–‡ä»¶å¯¼å‡ºä¸ºå„ç§æ ¼å¼çš„æ–‡ä»¶ï¼Œéœ€è¦æå‰å®‰è£… =brew install pandoc= ã€‚

#+begin_src emacs-lisp
(use-package ox-pandoc
  :ensure t
  :custom
  ;; special extensions for markdown_github output
  (org-pandoc-format-extensions '(markdown_github+pipe_tables+raw_html))
  (org-pandoc-command "/usr/local/bin/pandoc")
  )
#+end_src

*** ox-publishå¯¼å‡ºé™æ€ç«™ç‚¹è®¾ç½®

#+BEGIN_SRC emacs-lisp
(use-package ox-publish
  :ensure nil
  :commands (org-publish org-publish-all)
  :config
  (setq org-export-global-macros
      '(("timestamp" . "@@html:<span class=\"timestamp\">[$1]</span>@@")))

  ;; sitemap ç”Ÿæˆå‡½æ•°
  (defun my/org-sitemap-date-entry-format (entry style project)
    "Format ENTRY in org-publish PROJECT Sitemap format ENTRY ENTRY STYLE format that includes date."
    (let ((filename (org-publish-find-title entry project)))
      (if (= (length filename) 0)
          (format "*%s*" entry)
        (format "{{{timestamp(%s)}}} [[file:%s][%s]]"
                (format-time-string "%Y-%m-%d"
                                    (org-publish-find-date entry project))
                entry
                filename))))

  ;; è®¾ç½® org-publish çš„é¡¹ç›®åˆ—è¡¨
  (setq org-publish-project-alist
        '(
          ;; ç¬”è®°éƒ¨åˆ†
          ("org-notes"
           :base-directory "~/org/"
           :base-extension "org"
           :exclude "\\(tasks\\|test\\|scratch\\|diary\\|capture\\|mail\\|habits\\|resume\\|meetings\\|personal\\|org-beamer-example\\)\\.org\\|test\\|article\\|roam\\|hugo"
           :publishing-directory "~/public_html/"
           :recursive t                 ; include subdirectories if t
           :publishing-function org-html-publish-to-html
           :headline-levels 6
           :auto-preamble t
           :auto-sitemap t
           :sitemap-filename "sitemap.org"
           :sitemap-title "Sitemap"
           :sitemap-format-entry my/org-sitemap-date-entry-format)

          ;; é™æ€èµ„æºéƒ¨åˆ†
          ("org-static"
           :base-directory "~/org/"
           :base-extension "css\\|js\\|png\\|jpg\\|gif\\|pdf\\|mp3\\|ogg\\|swf\\|mov"
           :publishing-directory "~/public_html/"
           :recursive t
           :publishing-function org-publish-attachment)

          ;; é¡¹ç›®é›†åˆ
          ("org"
           :components ("org-notes" "org-static"))
          ))
  )
#+END_SRC

*** ox-hugoå¯¼å‡ºåšå®¢è®¾ç½®

[[https://github.com/kaushalmodi/ox-hugo][ox-hugo]] æ’ä»¶å¯ä»¥å°† org æ–‡ä»¶å¯¼å‡ºä¸º [[https://gohugo.io/][hugo]] éœ€è¦çš„ Markdown æ–‡ä»¶ï¼Œå¹¶å¿«é€Ÿé€šè¿‡ hugo è¿›è¡Œåšå®¢çš„ç”Ÿæˆå’Œå‘å¸ƒã€‚

#+BEGIN_SRC emacs-lisp
(use-package ox-hugo
  :ensure t
  :config
  (with-eval-after-load 'org-capture
    (defun org-hugo-new-subtree-post-capture-template ()
      "Returns `org-capture' template string for new Hugo post.
See `org-capture-templates' for more information."
      (let* ((title (read-from-minibuffer "Post Title: ")) ; Prompt to enter the post title
             (fname (org-hugo-slug title)))
        (mapconcat #'identity
                   `(
                     ,(concat "* TODO " title)
                     ":PROPERTIES:"
                     ,(concat ":EXPORT_FILE_NAME: " fname)
                     ":END:"
                     "%?\n")          ; Place the cursor here finally
                   "\n")))

    (add-to-list 'org-capture-templates
                 '("h"                ; `org-capture' binding + h
                   "Hugo post"
                   entry
                   ;; It is assumed that below file is present in `org-directory'
                   ;; and that it has a "Blog Ideas" heading. It can even be a
                   ;; symlink pointing to the actual location of capture.org!
                   (file+olp "capture.org" "Notes")
                   (function org-hugo-new-subtree-post-capture-template))))
  )
#+END_SRC

** å›¾ç‰‡ç²˜è´´

é€šè¿‡ =pngpaste= è¿™ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå°†ç³»ç»Ÿå‰ªè´´æ¿é‡Œçš„å›¾ç‰‡ï¼Œè¾“å‡ºåˆ°å½“å‰æ–‡ä»¶åŒåçš„ =assets= æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åè‡ªåŠ¨åœ¨å½“å‰orgæ–‡ä»¶çš„å…‰æ ‡å¤„æ’å…¥å›¾ç‰‡é“¾æ¥ï¼Œå¹¶è®¾ç½®å›¾ç‰‡é“¾æ¥çš„å®½åº¦å±æ€§ã€‚

#+BEGIN_SRC emacs-lisp
(use-package emacs
  :ensure nil
  :after org
  :bind (:map org-mode-map
              ("s-V" . my/org-insert-clipboard-image))
  :config
  (defun my/org-insert-clipboard-image (width)
    "create a time stamped unique-named file from the clipboard in the sub-directory
 (%filename.assets) as the org-buffer and insert a link to this file."
    (interactive (list
                  (read-string (format "Input image width, default is 800: ")
                               nil nil "800")))
    ;; è®¾ç½®å›¾ç‰‡å­˜æ”¾çš„æ–‡ä»¶å¤¹ä½ç½®ä¸º `å½“å‰Orgæ–‡ä»¶åŒå.assets'
    (setq foldername (concat (file-name-base (buffer-file-name)) ".assets/"))
    (if (not (file-exists-p foldername))
        (mkdir foldername))
    ;; è®¾ç½®å›¾ç‰‡çš„æ–‡ä»¶åï¼Œæ ¼å¼ä¸º `img_å¹´æœˆæ—¥_æ—¶åˆ†ç§’.png'
    (setq imgName (concat "img_" (format-time-string "%Y%m%d_%H%M%S") ".png"))
    ;; å›¾ç‰‡æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
    (setq relativeFilename (concat (file-name-base (buffer-name)) ".assets/" imgName))
    ;; æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿè®¾ç½®ä¸åŒçš„å‘½ä»¤è¡Œå·¥å…·
    (cond ((string-equal system-type "gnu/linux")
           (shell-command (concat "xclip -selection clipboard -t image/png -o > " relativeFilename)))
          ((string-equal system-type "darwin")
           (shell-command (concat "pngpaste " relativeFilename))))
    ;; ç»™ç²˜è´´å¥½çš„å›¾ç‰‡é“¾æ¥åŠ ä¸Šå®½åº¦å±æ€§ï¼Œæ–¹ä¾¿å¯¼å‡º
    (insert (concat "\n#+DOWNLOADED: screenshot @ "
                    (format-time-string "%Y-%m-%d %a %H:%M:%S" (current-time))
                    "\n#+CAPTION: \n#+ATTR_ORG: :width "
                    width
                    "\n#+ATTR_LATEX: :width "
                    (if (>= (/ (string-to-number width) 800.0) 1.0)
                        "1.0"
                      (number-to-string (/ (string-to-number width) 800.0)))
                    "\\linewidth :float nil\n"
                    "#+ATTR_HTML: :width "
                    width
                    "\n[[file:" relativeFilename "]]\n"))
    ;; é‡æ–°æ˜¾ç¤ºä¸€ä¸‹å›¾ç‰‡
    (org-redisplay-inline-images)
    )
  )
#+END_SRC

** toc-orgç›®å½•è‡ªåŠ¨ç”Ÿæˆ

[[https://github.com/snosov1/toc-org][toc-org]] æ’ä»¶å¯ä»¥åœ¨Orgæ–‡ä»¶é‡Œè‡ªåŠ¨ç”Ÿæˆç›®å½•ï¼Œåªéœ€ç»™ä¸€ä¸ªæ ‡é¢˜è¡Œè®¾ç½®ä¸€ä¸ªæ ‡ç­¾ä¸º =toc= æˆ– =toc_2= å³å¯ï¼ˆåè€…åªç”Ÿæˆ2å±‚ï¼‰ã€‚

#+BEGIN_SRC emacs-lisp
(use-package toc-org
  :ensure t
  :hook (org-mode . toc-org-mode))
#+END_SRC

** olæ–°å¢é“¾æ¥ç±»å‹

[[google:Org mode][google Org mode]]

#+BEGIN_SRC emacs-lisp
(use-package ol
  :ensure nil
  :defer t
  :custom
  (org-link-keep-stored-after-insertion t)
  (org-link-abbrev-alist '(("github"        . "https://github.com/")
                           ("gitlab"        . "https://gitlab.com/")
                           ("google"        . "https://google.com/search?q=")
                           ("baidu"         . "https://baidu.com/s?wd=")
                           ("rfc"           . "https://tools.ietf.org/html/")
                           ("wiki"          . "https://en.wikipedia.org/wiki/")
                           ("youtube"       . "https://youtube.com/watch?v=")
                           ("zhihu"         . "https://zhihu.com/question/"))))
#+END_SRC

** Org mode ä»»åŠ¡ç®¡ç†

*** calendaråŸºæœ¬è®¾ç½®

#+BEGIN_SRC emacs-lisp
(use-package calendar
  :ensure nil
  :hook (calendar-today-visible . calendar-mark-today)
  :custom
  ;; æ˜¯å¦æ˜¾ç¤ºä¸­å›½èŠ‚æ—¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ `cal-chinese-x' æ’ä»¶
  (calendar-chinese-all-holidays-flag nil)
  ;; æ˜¯å¦æ˜¾ç¤ºèŠ‚æ—¥
  (calendar-mark-holidays-flag t)
  ;; æ˜¯å¦æ˜¾ç¤ºEmacsçš„æ—¥è®°ï¼Œæˆ‘ä»¬ä½¿ç”¨orgçš„æ—¥è®°
  (calendar-mark-diary-entries-flag nil)
  ;; æ•°å­—æ–¹å¼æ˜¾ç¤ºæ—¶åŒºï¼Œå¦‚ +0800ï¼Œé»˜è®¤æ˜¯å­—ç¬¦æ–¹å¼å¦‚ CST
  (calendar-time-zone-style 'numeric)
  ;; æ—¥æœŸæ˜¾ç¤ºæ–¹å¼ï¼šyear/month/day
  (calendar-date-style 'iso)
  ;; ä¸­æ–‡å¤©å¹²åœ°æ”¯è®¾ç½®
  (calendar-chinese-celestial-stem ["ç”²" "ä¹™" "ä¸™" "ä¸" "æˆŠ" "å·±" "åºš" "è¾›" "å£¬" "ç™¸"])
  (calendar-chinese-terrestrial-branch ["å­" "ä¸‘" "å¯…" "å¯" "è¾°" "å·³" "åˆ" "æœª" "ç”³" "é…‰" "æˆŒ" "äº¥"])
  ;; è®¾ç½®ä¸­æ–‡æœˆä»½
  (calendar-month-name-array ["ä¸€æœˆ" "äºŒæœˆ" "ä¸‰æœˆ" "å››æœˆ" "äº”æœˆ" "å…­æœˆ" "ä¸ƒæœˆ" "å…«æœˆ" "ä¹æœˆ" "åæœˆ" "åä¸€æœˆ" "åäºŒæœˆ"])
  ;; è®¾ç½®æ˜ŸæœŸæ ‡é¢˜æ˜¾ç¤º
  (calendar-day-name-array ["æ—¥" "ä¸€" "äºŒ" "ä¸‰" "å››" "äº”" "å…­"])
  ;; å‘¨ä¸€ä½œä¸ºä¸€å‘¨ç¬¬ä¸€å¤©
  (calendar-week-start-day 1)
  )
#+END_SRC

*** æ—¥å†ä¸­æ–‡å¢å¼º

æˆ‘ä»¬é€šè¿‡ [[https://github.com/xwl/cal-china-x][cal-china-x]] æ’ä»¶è¿›ä¸€æ­¥åœ°å¢å¼ºä¸­æ–‡æ—¥å†ï¼Œæ˜¾ç¤ºå†œå†ç­‰ä¿¡æ¯ã€‚

#+BEGIN_SRC emacs-lisp
;; æ—¶é—´è§£æå¢åŠ ä¸­æ–‡æ‹¼éŸ³
(use-package parse-time
  :ensure nil
  :defer t
  :config
  (setq parse-time-months
        (append '(("yiy" . 1) ("ery" . 2) ("sany" . 3)
                  ("siy" . 4) ("wuy" . 5) ("liuy" . 6)
                  ("qiy" . 7) ("bay" . 8) ("jiuy" . 9)
                  ("shiy" . 10) ("shiyiy" . 11) ("shiery" . 12)
                  ("yiyue" . 1) ("eryue" . 2) ("sanyue" . 3)
                  ("siyue" . 4) ("wuyue" . 5) ("liuyue" . 6)
                  ("qiyue" . 7) ("bayue" . 8) ("jiuyue" . 9)
                  ("shiyue" . 10) ("shiyiyue" . 11) ("shieryue" . 12))
                parse-time-months))

  (setq parse-time-weekdays
        (append '(("zri" . 0) ("zqi" . 0)
                  ("zyi" . 1) ("zer" . 2) ("zsan" . 3)
                  ("zsi" . 4) ("zwu" . 5) ("zliu" . 6)
                  ("zr" . 0) ("zq" . 0)
                  ("zy" . 1) ("ze" . 2) ("zs" . 3)
                  ("zsi" . 4) ("zw" . 5) ("zl" . 6))
                parse-time-weekdays)))

;; ä¸­å›½èŠ‚æ—¥è®¾ç½®
(use-package cal-china-x
  :ensure t
  :commands cal-china-x-setup
  :hook (after-init . cal-china-x-setup)
  :config
  ;; é‡è¦èŠ‚æ—¥è®¾ç½®
  (setq cal-china-x-important-holidays cal-china-x-chinese-holidays)
  ;; æ‰€æœ‰èŠ‚æ—¥è®¾ç½®
  (setq cal-china-x-general-holidays
        '(;;å…¬å†èŠ‚æ—¥
          (holiday-fixed 1 1 "å…ƒæ—¦")
          (holiday-fixed 2 14 "æƒ…äººèŠ‚")
          (holiday-fixed 3 8 "å¦‡å¥³èŠ‚")
          (holiday-fixed 3 14 "ç™½è‰²æƒ…äººèŠ‚")
          (holiday-fixed 4 1 "æ„šäººèŠ‚")
          (holiday-fixed 5 1 "åŠ³åŠ¨èŠ‚")
          (holiday-fixed 5 4 "é’å¹´èŠ‚")
          (holiday-float 5 0 2 "æ¯äº²èŠ‚")
          (holiday-fixed 6 1 "å„¿ç«¥èŠ‚")
          (holiday-float 6 0 3 "çˆ¶äº²èŠ‚")
          (holiday-fixed 9 10 "æ•™å¸ˆèŠ‚")
          (holiday-fixed 10 1 "å›½åº†èŠ‚")
          (holiday-fixed 10 2 "å›½åº†èŠ‚")
          (holiday-fixed 10 3 "å›½åº†èŠ‚")
          (holiday-fixed 10 24 "ç¨‹åºå‘˜èŠ‚")
          (holiday-fixed 11 11 "åŒ11è´­ç‰©èŠ‚")
          (holiday-fixed 12 25 "åœ£è¯èŠ‚")
          ;; å†œå†èŠ‚æ—¥
          (holiday-lunar 12 30 "æ˜¥èŠ‚" 0)
          (holiday-lunar 1 1 "æ˜¥èŠ‚" 0)
          (holiday-lunar 1 2 "æ˜¥èŠ‚" 0)
          (holiday-lunar 1 15 "å…ƒå®µèŠ‚" 0)
          (holiday-solar-term "æ¸…æ˜" "æ¸…æ˜èŠ‚")
          (holiday-solar-term "å°å¯’" "å°å¯’")
          (holiday-solar-term "å¤§å¯’" "å¤§å¯’")
          (holiday-solar-term "ç«‹æ˜¥" "ç«‹æ˜¥")
          (holiday-solar-term "é›¨æ°´" "é›¨æ°´")
          (holiday-solar-term "æƒŠè›°" "æƒŠè›°")
          (holiday-solar-term "æ˜¥åˆ†" "æ˜¥åˆ†")
          (holiday-solar-term "è°·é›¨" "è°·é›¨")
          (holiday-solar-term "ç«‹å¤" "ç«‹å¤")
          (holiday-solar-term "å°æ»¡" "å°æ»¡")
          (holiday-solar-term "èŠ’ç§" "èŠ’ç§")
          (holiday-solar-term "å¤è‡³" "å¤è‡³")
          (holiday-solar-term "å°æš‘" "å°æš‘")
          (holiday-solar-term "å¤§æš‘" "å¤§æš‘")
          (holiday-solar-term "ç«‹ç§‹" "ç«‹ç§‹")
          (holiday-solar-term "å¤„æš‘" "å¤„æš‘")
          (holiday-solar-term "ç™½éœ²" "ç™½éœ²")
          (holiday-solar-term "ç§‹åˆ†" "ç§‹åˆ†")
          (holiday-solar-term "å¯’éœ²" "å¯’éœ²")
          (holiday-solar-term "éœœé™" "éœœé™")
          (holiday-solar-term "ç«‹å†¬" "ç«‹å†¬")
          (holiday-solar-term "å°é›ª" "å°é›ª")
          (holiday-solar-term "å¤§é›ª" "å¤§é›ª")
          (holiday-solar-term "å†¬è‡³" "å†¬è‡³")
          (holiday-lunar 5 5 "ç«¯åˆèŠ‚" 0)
          (holiday-lunar 8 15 "ä¸­ç§‹èŠ‚" 0)
          (holiday-lunar 7 7 "ä¸ƒå¤•æƒ…äººèŠ‚" 0)
          (holiday-lunar 12 8 "è…Šå…«èŠ‚" 0)
          (holiday-lunar 9 9 "é‡é˜³èŠ‚" 0)))
  ;; è®¾ç½®æ—¥å†çš„èŠ‚æ—¥ï¼Œé€šç”¨èŠ‚æ—¥å·²ç»åŒ…å«äº†æ‰€æœ‰èŠ‚æ—¥
  (setq calendar-holidays (append cal-china-x-general-holidays)))
#+END_SRC

*** org-agendaåŸºæœ¬è®¾ç½®

#+BEGIN_SRC emacs-lisp
(use-package org-agenda
  :ensure nil
  :hook (org-agenda-finalize . org-agenda-to-appt)
  :bind (("\e\e a" . org-agenda)
         :map org-agenda-mode-map
         ("i" . (lambda () (interactive) (org-capture nil "d")))
         ("J" . consult-org-agenda))
  :config
  ;; æ—¥ç¨‹æ¨¡å¼çš„æ—¥æœŸæ ¼å¼è®¾ç½®
  (setq org-agenda-format-date 'org-agenda-format-date-aligned)
  (defun org-agenda-format-date-aligned (date)
    "Format a DATE string for display in the daily/weekly agenda, or timeline.

This function makes sure that dates are aligned for easy reading."
    (require 'cal-iso)
    (let* ((dayname (aref cal-china-x-days
                          (calendar-day-of-week date)))
           (day (cadr date))
           (month (car date))
           (year (nth 2 date))
           (day-of-week (calendar-day-of-week date))
           (iso-week (org-days-to-iso-week
                      (calendar-absolute-from-gregorian date)))
           (cn-date (calendar-chinese-from-absolute (calendar-absolute-from-gregorian date)))
           (cn-month (cl-caddr cn-date))
           (cn-day (cl-cadddr cn-date))
           (cn-month-string (concat (aref cal-china-x-month-name
                                          (1- (floor cn-month)))
                                    (if (integerp cn-month)
                                        ""
                                      "ï¼ˆé—°æœˆï¼‰")))
           (cn-day-string (aref cal-china-x-day-name
                                (1- cn-day)))
           (extra (format " å†œå†%s%s%s%s"
                          (if (or (eq org-agenda-current-span 'day)
                                  (= day-of-week 1)
                                  (= cn-day 1))
                              cn-month-string
                            "")
                          (if (or (= day-of-week 1)
                                  (= cn-day 1))
                              (if (integerp cn-month) "" "[é—°]")
                            "")
                          cn-day-string
                          (if (or (= day-of-week 1)
                                  (eq org-agenda-current-span 'day))
                              (format " ä»Šå¹´ç¬¬%02då‘¨" iso-week)
                            "")
                          ))
           )
      (format "%04d-%02d-%02d æ˜ŸæœŸ%s%s%s\n" year month
              day dayname extra (concat " ç¬¬" (format-time-string "%j") "å¤©"))))

  ;; æ˜¾ç¤ºæ—¶é—´çº¿
  (setq org-agenda-use-time-grid t)
  ;; è®¾ç½®é¢åŒ…å±‘åˆ†éš”ç¬¦
  ;; (setq org-agenda-breadcrumbs-separator " â± ")
  ;; è®¾ç½®æ—¶é—´çº¿çš„å½“å‰æ—¶é—´æŒ‡ç¤ºä¸²
  (setq org-agenda-current-time-string "â°------------now")
  ;; æ—¶é—´çº¿èŒƒå›´å’Œé¢—ç²’åº¦è®¾ç½®
  (setq org-agenda-time-grid (quote ((daily today)
                                     (0600 0800 1000 1200
                                           1400 1600 1800
                                           2000 2200 2400)
                                     "......" "----------------")))
  ;; æ—¥ç¨‹è§†å›¾çš„å‰ç¼€è®¾ç½®
  (setq org-agenda-prefix-format '((agenda . " %i %-25:c %5t %s")
                                   (todo   . " %i %-25:c ")
                                   (tags   . " %i %-25:c ")
                                   (search . " %i %-25:c ")))
  ;; å¯¹äºè®¡åˆ’ä¸­çš„ä»»åŠ¡åœ¨è§†å›¾é‡Œçš„æ˜¾ç¤º
  (setq org-agenda-scheduled-leaders
        '("è®¡åˆ’ " "åº”åœ¨%02då¤©å‰å¼€å§‹ "))
  ;; å¯¹äºæˆªæ­¢æ—¥æœŸçš„ä»»åŠ¡åœ¨è§†å›¾é‡Œçš„æ˜¾ç¤º
  (setq org-agenda-deadline-leaders
        '("æˆªæ­¢ " "è¿˜æœ‰%02då¤©åˆ°æœŸ " "å·²ç»è¿‡æœŸ%02då¤© "))

  ;; =====================
  ;; è‡ªå®šä¹‰æ—¥ç¨‹è§†å›¾ï¼Œåˆ†åˆ«æ˜¾ç¤ºTODOï¼ŒWIPï¼ŒWIATä¸­çš„ä»»åŠ¡
  ;; né”®æ˜¾ç¤ºè‡ªå®šä¹‰è§†å›¾ï¼Œpé”®çº¯æ–‡æœ¬è§†å›¾ï¼Œaé”®é»˜è®¤è§†å›¾
  ;; =====================
  (defvar my-org-custom-daily-agenda
    `((todo "TODO"
            ((org-agenda-block-separator nil)
             (org-agenda-overriding-header "æ‰€æœ‰å¾…åŠä»»åŠ¡\n")))
      (todo "WIP"
            ((org-agenda-block-separator nil)
             (org-agenda-overriding-header "\nè¿›è¡Œä¸­çš„ä»»åŠ¡\n")))
      (todo "WAIT"
            ((org-agenda-block-separator nil)
             (org-agenda-overriding-header "\nç­‰å¾…ä¸­çš„ä»»åŠ¡\n")))
      (agenda "" ((org-agenda-block-separator nil)
                  (org-agenda-overriding-header "\nä»Šæ—¥æ—¥ç¨‹\n"))))
    "Custom agenda for use in `org-agenda-custom-commands'.")
  (setq org-agenda-custom-commands
        `(("n" "Daily agenda and top priority tasks"
           ,my-org-custom-daily-agenda)
          ("p" "Plain text daily agenda and top priorities"
           ,my-org-custom-daily-agenda
           ((org-agenda-with-colors nil)
            (org-agenda-prefix-format "%t %s")
            (org-agenda-current-time-string ,(car (last org-agenda-time-grid)))
            (org-agenda-fontify-priorities nil)
            (org-agenda-remove-tags t))
           ("agenda.txt"))))

  ;; æ—¶é—´æˆ³æ ¼å¼è®¾ç½®ï¼Œä¼šå½±å“åˆ° `svg-tag' ç­‰åŸºäºæ­£åˆ™çš„è®¾ç½®
  ;; è¿™é‡Œè®¾ç½®å®Œåæ˜¯ <2022-12-24 æ˜ŸæœŸå…­> æˆ– <2022-12-24 æ˜ŸæœŸå…­ 06:53>
  (setq system-time-locale "zh_CN.UTF-8")
  (setq org-time-stamp-formats '("<%Y-%m-%d %A>" . "<%Y-%m-%d %A %H:%M>"))
  ;; ä¸åŒæ—¥ç¨‹ç±»åˆ«é—´çš„é—´éš”
  (setq org-cycle-separator-lines 2)
  :custom
  ;; è®¾ç½®éœ€è¦è¢«æ—¥ç¨‹ç›‘æ§çš„orgæ–‡ä»¶
  (org-agenda-files
   (list (expand-file-name "tasks.org" org-directory)
         (expand-file-name "diary.org" org-directory)
         (expand-file-name "habits.org" org-directory)
         (expand-file-name "mail.org" org-directory)
         (expand-file-name "emacs-config.org" user-emacs-directory)
         ))
  ;; è®¾ç½®orgçš„æ—¥è®°æ–‡ä»¶
  (org-agenda-diary-file (expand-file-name "diary.org" org-directory))
  ;; æ—¥è®°æ’å…¥ç²¾ç¡®æ—¶é—´æˆ³
  (org-agenda-insert-diary-extract-time t)
  ;; è®¾ç½®æ—¥ç¨‹è§†å›¾æ›´åŠ ç´§å‡‘
  ;; (org-agenda-compact-blocks t)
  ;; æ—¥ç¨‹è§†å›¾çš„å—åˆ†éš”ç¬¦
  (org-agenda-block-separator ?â”€)
  ;; æ—¥è§†å›¾è¿˜æ˜¯å‘¨è§†å›¾ï¼Œé€šè¿‡ v-d, v-w, v-m, v-y åˆ‡æ¢è§†å›¾ï¼Œé»˜è®¤å‘¨è§†å›¾
  (org-agenda-span 'day)
  ;; qé€€å‡ºæ—¶åˆ é™¤agendaç¼“å†²åŒº
  (org-agenda-sticky t)
  ;; æ˜¯å¦åŒ…å«ç›´æ¥æ—¥æœŸ
  (org-agenda-include-deadlines t)
  ;; ç¦æ­¢æ—¥ç¨‹å¯åŠ¨ç”»é¢
  (org-agenda-inhibit-startup t)
  ;; æ˜¾ç¤ºæ¯ä¸€å¤©ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æ¡ç›®
  (org-agenda-show-all-dates t)
  ;; æ—¶é—´ä¸è¶³ä½æ—¶å‰é¢åŠ 0
  (org-agenda-time-leading-zero t)
  ;; æ—¥ç¨‹åŒæ—¶å¯åŠ¨log mode
  (org-agenda-start-with-log-mode t)
  ;; æ—¥ç¨‹åŒæ—¶å¯åŠ¨ä»»åŠ¡æ—¶é—´è®°å½•æŠ¥å‘Šæ¨¡å¼
  (org-agenda-start-with-clockreport-mode t)
  ;; æˆªæ­¢çš„ä»»åŠ¡å®Œæˆåä¸æ˜¾ç¤º
  ;; (org-agenda-skip-deadline-if-done t)
  ;; å½“è®¡åˆ’çš„ä»»åŠ¡å®Œæˆåä¸æ˜¾ç¤º
  (org-agenda-skip-scheduled-if-done t)
  ;; è®¡åˆ’è¿‡æœŸä¸Šé™
  (org-scheduled-past-days 365)
  ;; è®¡åˆ’æˆªæ­¢ä¸Šé™
  (org-deadline-past-days 365)
  ;; è®¡åˆ’ä¸­çš„ä»»åŠ¡ä¸æé†’æˆªæ­¢æ—¶é—´
  (org-agenda-skip-deadline-prewarning-if-scheduled 1)
  (org-agenda-skip-scheduled-if-deadline-is-shown t)
  (org-agenda-skip-timestamp-if-deadline-is-shown t)
  ;; è®¾ç½®å·¥æ—¶è®°å½•æŠ¥å‘Šæ ¼å¼
  (org-agenda-clockreport-parameter-plist
   '(:link t :maxlevel 5 :fileskip0 t :compact nil :narrow 80))
  (org-agenda-columns-add-appointments-to-effort-sum t)
  (org-agenda-restore-windows-after-quit t)
  (org-agenda-window-setup 'current-window)
  ;; æ ‡ç­¾æ˜¾ç¤ºçš„ä½ç½®ï¼Œç¬¬100åˆ—å¾€å‰å³å¯¹é½
  (org-agenda-tags-column -100)
  ;; ä»æ˜ŸæœŸä¸€å¼€å§‹ä½œä¸ºä¸€å‘¨ç¬¬ä¸€å¤©
  (org-agenda-start-on-weekday 1)
  ;; æ˜¯å¦ä½¿ç”¨am/pm
  ;; (org-agenda-timegrid-use-ampm nil)
  ;; æœç´¢æ˜¯ä¸çœ‹æ—¶é—´
  (org-agenda-search-headline-for-time nil)
  ;; æå‰3å¤©æˆªæ­¢æ—¥æœŸåˆ°æœŸå‘Šè­¦
  (org-deadline-warning-days 3)
  )
#+END_SRC

*** org-habitä¹ æƒ¯ç®¡ç†

#+begin_src emacs-lisp
(use-package org-habit
  :ensure nil
  :defer t
  :custom
  (org-habit-show-habits t)
  (org-habit-graph-column 70)
  (org-habit-show-all-today t)
  (org-habit-show-done-always-green t)
  (org-habit-scheduled-past-days t)
  ;; org habit show 7 days before today and 7 days after today. ! means not done. * means done.
  (org-habit-preceding-days 7)
  )
#+end_src

*** appté‚€çº¦æé†’

Emacsçš„é‚€çº¦æé†’ï¼Œå¹¶é›†æˆorg-agendaæé†’ï¼š

#+BEGIN_SRC emacs-lisp
(use-package appt
  :ensure nil
  :hook ((after-init . (lambda () (appt-activate 1)))
         (org-finalize-agenda . org-agenda-to-appt))
  :config
  ;; é€šçŸ¥æé†’
  (defun appt-display-with-notification (min-to-app new-time appt-msg)
    (notify-send :title (format "Appointment in %s minutes" min-to-app)
                 :body appt-msg
                 :urgency 'critical)
    (appt-disp-window min-to-app new-time appt-msg))

  ;; æ¯15åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡appt
  (run-at-time t 900 #'org-agenda-to-appt)

  :custom
  ;; æ˜¯å¦æ˜¾ç¤ºæ—¥è®°
  (appt-display-diary nil)
  ;; æé†’é—´éš”æ—¶é—´ï¼Œæ¯15åˆ†é’Ÿæé†’ä¸€æ¬¡
  (appt-display-interval 15)
  ;; æ¨¡å¼æ æ˜¾ç¤ºæé†’
  (appt-display-mode-line t)
  ;; è®¾ç½®æé†’å“é“ƒ
  (appt-audible t)
  ;; æå‰30åˆ†é’Ÿæé†’
  (appt-message-warning-time 30)
  ;; é€šçŸ¥æé†’å‡½æ•°
  (appt-disp-window-function #'appt-display-with-notification)
  )
#+END_SRC

** init-org.el æ–‡ä»¶å°¾

#+BEGIN_SRC emacs-lisp

(provide 'init-org)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-org.el ends here
#+END_SRC

* init-completion.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-completion.el :mkdirp yes
:END:

Emacsçš„è¡¥å…¨è®¾ç½®ã€‚

** init-completion.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-completion.el --- Completion settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** vertico

[[https://github.com/minad/vertico][vertico]] æ’ä»¶æä¾›äº†ä¸€ä¸ªå‚ç›´æ ·å¼çš„è¡¥å…¨ç³»ç»Ÿã€‚

#+BEGIN_SRC emacs-lisp
  (use-package vertico
    :ensure t
    :hook (after-init . vertico-mode)
    :bind (:map minibuffer-local-map
                ("M-<DEL>" . my/minibuffer-backward-kill)
                :map vertico-map
                ("M-q" . vertico-quick-insert)) ; use C-g to exit
    :config
    (defun my/minibuffer-backward-kill (arg)
      "When minibuffer is completing a file name delete up to parent
  folder, otherwise delete a word"
      (interactive "p")
      (if minibuffer-completing-file-name
          ;; Borrowed from https://github.com/raxod502/selectrum/issues/498#issuecomment-803283608
          (if (string-match-p "/." (minibuffer-contents))
              (zap-up-to-char (- arg) ?/)
            (delete-minibuffer-contents))
        (backward-kill-word arg)))

    ;; Do not allow the cursor in the minibuffer prompt
    (setq minibuffer-prompt-properties
          '(read-only t cursor-intangible t face minibuffer-prompt))
    (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)
    
    (setq vertico-cycle t)                ; cycle from last to first
    :custom
    (vertico-count 15)                    ; number of candidates to display, default is 10
    )
#+END_SRC

** orderless

[[https://github.com/oantolin/orderless][oderless]] æ’ä»¶æä¾›ä¸€ç§æ— åºçš„è¡¥å…¨æ–°å§¿åŠ¿ï¼Œå°†ä¸€ä¸ªæœç´¢çš„èŒƒå¼å˜æˆæ•°ä¸ªä»¥ç©ºæ ¼åˆ†éš”çš„éƒ¨åˆ†ï¼Œå„éƒ¨åˆ†ä¹‹é—´æ²¡æœ‰é¡ºåºï¼Œä½ è¦åšçš„å°±æ˜¯æ ¹æ®è®°å¿†è¾“å…¥å…³é”®è¯ã€ç©ºæ ¼ã€å…³é”®è¯ã€‚

#+BEGIN_SRC emacs-lisp
;; support Pinyin first character match for orderless, avy etc.
(use-package pinyinlib
  :ensure t)

;; orderless æ˜¯ä¸€ç§å“²å­¦æ€æƒ³
(use-package orderless
  :ensure t
  :init
  (setq completion-styles '(orderless partial-completion basic))
  (setq orderless-component-separator "[ &]") ; & is for company because space will break completion
  (setq completion-category-defaults nil)
  (setq completion-category-overrides nil)
  :config
  ;; make completion support pinyin, refer to
  ;; https://emacs-china.org/t/vertico/17913/2
  (defun completion--regex-pinyin (str)
    (orderless-regexp (pinyinlib-build-regexp-string str)))
  (add-to-list 'orderless-matching-styles 'completion--regex-pinyin)
  )
#+END_SRC

** marginalia

[[https://github.com/minad/marginalia][marginalia]] æ’ä»¶ç»™è¿·ä½ ç¼“å†²åŒºçš„è¡¥å…¨å€™é€‰æ¡ç›®æ·»åŠ ä¸€äº›æç¤ºã€‚

#+BEGIN_SRC emacs-lisp
;; minibuffer helpful annotations
(use-package marginalia
  :ensure t
  :hook (after-init . marginalia-mode)
  :custom
  (marginalia-annotators '(marginalia-annotators-heavy marginalia-annotators-light nil)))
#+END_SRC

** consult

[[https://github.com/minad/consult][consult]] æ’ä»¶åŸºäºEmacsè‡ªå¸¦çš„è¡¥å…¨æœºåˆ¶ï¼Œæä¾›äº†ä¸€ç³»åˆ—çš„è¡¥å…¨å‘½ä»¤ã€‚

#+BEGIN_QUOTE
For locate on MacOS:

1. =locate= is not enabled in MacOS by default. We need to enable it via:
   sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.locate.plist

2. Then we need to wait =locate= to build db for the whole file system.

3. If there is something wrong with updating locate db, we can update it manually via:
   chomd 755 ~/Library ~/Downloads ~/Documents ~/Desktop
   sudo /usr/libexec/locate.updatedb
#+END_QUOTE

#+BEGIN_SRC emacs-lisp
  (use-package consult
    :ensure t
    :after org
    :bind (([remap goto-line]                     . consult-goto-line)
           ([remap isearch-forward]               . consult-line-symbol-at-point) ; my-consult-ripgrep-or-line
           ([remap switch-to-buffer]              . consult-buffer)
           ([remap switch-to-buffer-other-window] . consult-buffer-other-window)
           ([remap switch-to-buffer-other-frame]  . consult-buffer-other-frame)
           ([remap yank-pop]                      . consult-yank-pop)
           ([remap apropos]                       . consult-apropos)
           ([remap bookmark-jump]                 . consult-bookmark)
           ([remap goto-line]                     . consult-goto-line)
           ([remap imenu]                         . consult-imenu)
           ([remap multi-occur]                   . consult-multi-occur)
           ([remap recentf-open-files]            . consult-recent-file)
           ("C-x j"                               . consult-mark)
           ("C-c g"                               . consult-ripgrep)
           ("C-c f"                               . consult-find)
           ("\e\ef"                               . consult-locate) ; need to enable locate first
           ("C-c n h"                             . my/consult-find-org-headings)
           :map org-mode-map
           ("C-c C-j"                             . consult-org-heading)
           :map minibuffer-local-map
           ("C-r"                                 . consult-history)
           :map isearch-mode-map
           ("C-;"                                 . consult-line)
           :map prog-mode-map
           ("C-c C-j"                             . consult-outline)
           )
    :hook (completion-list-mode . consult-preview-at-point-mode)
    :init
    ;; Optionally configure the register formatting. This improves the register
    ;; preview for `consult-register', `consult-register-load',
    ;; `consult-register-store' and the Emacs built-ins.
    (setq register-preview-delay 0
          register-preview-function #'consult-register-format)

    ;; Optionally tweak the register preview window.
    ;; This adds thin lines, sorting and hides the mode line of the window.
    (advice-add #'register-preview :override #'consult-register-window)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; MacOS locate doesn't support `--ignore-case --existing' args.
    (setq consult-locate-args (pcase system-type
                                ('gnu/linux "locate --ignore-case --existing --regex")
                                ('darwin "mdfind -name")))
    :config
    (consult-customize
     consult-theme
     :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-recent-file consult--source-project-recent-file consult--source-bookmark
     :preview-key (kbd "M-."))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; (kbd "C-+")

    (autoload 'projectile-project-root "projectile")
    (setq consult-project-root-function #'projectile-project-root)

    ;; search all org file headings under a directory, see:
    ;; https://emacs-china.org/t/org-files-heading-entry/20830/4
    (defun my/consult-find-org-headings (&optional match)
      "find headngs in all org files."
      (interactive)
      (consult-org-heading match (directory-files org-directory t "^[0-9]\\{8\\}.+\\.org$")))

    ;; Use `consult-ripgrep' instead of `consult-line' in large buffers
    (defun consult-line-symbol-at-point ()
      "Consult line the synbol where the point is"
      (interactive)
      (consult-line (thing-at-point 'symbol)))
    )
#+END_SRC

** corfu

[[https://github.com/minad/corfu][corfu]] é€šè¿‡å¼¹çª—è¿›è¡Œè¡¥å…¨ã€‚

#+BEGIN_SRC emacs-lisp
(use-package corfu
  :ensure t
  :hook (after-init . global-corfu-mode)
  :bind
  (:map corfu-map
        ("SPC" . corfu-insert-separator)    ; configure space for separator insertion
        ("M-q" . corfu-quick-complete)      ; use C-g to exit
        ("TAB" . corfu-next)
        ([tab] . corfu-next)
        ("S-TAB" . corfu-previous)
        ([backtab] . corfu-previous))
  :config
  ;; TAB cycle if there are only few candidates
  (setq completion-cycle-threshold 0)
  (setq tab-always-indent 'complete)

  (defun corfu-enable-always-in-minibuffer ()
    "Enable Corfu in the minibuffer if Vertico/Mct are not active."
    (unless (or (bound-and-true-p mct--active)
                (bound-and-true-p vertico--input))
      ;; (setq-local corfu-auto nil) Enable/disable auto completion
      (corfu-mode 1)))
  (add-hook 'minibuffer-setup-hook #'corfu-enable-always-in-minibuffer 1)

  ;; enable corfu in eshell
  (add-hook 'eshell-mode-hook
            (lambda ()
              (setq-local corfu-auto nil)
              (corfu-mode)))

  ;; For Eshell
  ;; ===========
  ;; avoid press RET twice in Eshell
  (defun corfu-send-shell (&rest _)
    "Send completion candidate when inside comint/eshell."
    (cond
     ((and (derived-mode-p 'eshell-mode) (fboundp 'eshell-send-input))
      (eshell-send-input))
     ((and (derived-mode-p 'comint-mode)  (fboundp 'comint-send-input))
      (comint-send-input))))
  ;; (advice-add #'corfu-insert :after #'corfu-send-shell)

  :custom
  (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
  )
#+END_SRC

*** cape

[[https://github.com/minad/cape][Cape]] æä¾›äº†ä¸€ç³»åˆ—å¼€ç®±å³ç”¨çš„è¡¥å…¨åç«¯ï¼Œè·Ÿcorfuè”åˆä½¿ç”¨ã€‚

#+BEGIN_SRC emacs-lisp
  (use-package cape
    :ensure t
    :init
    ;; Add `completion-at-point-functions', used by `completion-at-point'.
    (add-to-list 'completion-at-point-functions #'cape-file)
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-keyword)  ; programming language keyword
    (add-to-list 'completion-at-point-functions #'cape-ispell)
    (add-to-list 'completion-at-point-functions #'cape-dict)
    (add-to-list 'completion-at-point-functions #'cape-symbol)   ; elisp symbol
    (add-to-list 'completion-at-point-functions #'cape-line)

    :config
    (setq cape-dict-file (expand-file-name "etc/hunspell_dict.txt" user-emacs-directory))

    ;; for Eshell:
    ;; ===========
    ;; Silence the pcomplete capf, no errors or messages!
    (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-silent)

    ;; Ensure that pcomplete does not write to the buffer
    ;; and behaves as a pure `completion-at-point-function'.
    (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-purify)
    )
#+END_SRC

** yasnippetæ¨¡æ¿è¡¥å…¨

[[https://github.com/joaotavora/yasnippet][yasnippet]] æ’ä»¶æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„æ¨¡æ¿è¡¥å…¨ç³»ç»Ÿã€‚

#+begin_src emacs-lisp
;; yasnippet settings
(use-package yasnippet
  :ensure t
  :diminish yas-minor-mode
  :hook ((after-init . yas-reload-all)
         ((prog-mode LaTeX-mode org-mode) . yas-minor-mode))
  :config
  ;; Suppress warning for yasnippet code.
  (require 'warnings)
  (add-to-list 'warning-suppress-types '(yasnippet backquote-change))

  (setq yas-prompt-functions '(yas-x-prompt yas-dropdown-prompt))
  (defun smarter-yas-expand-next-field ()
    "Try to `yas-expand' then `yas-next-field' at current cursor position."
    (interactive)
    (let ((old-point (point))
          (old-tick (buffer-chars-modified-tick)))
      (yas-expand)
      (when (and (eq old-point (point))
                 (eq old-tick (buffer-chars-modified-tick)))
        (ignore-errors (yas-next-field))))))
#+end_src

** all-the-icons-completionè¡¥å…¨å›¾æ ‡ç¾åŒ–

[[https://github.com/iyefrat/all-the-icons-completion][all-the-icons-completion]] æ’ä»¶ç»™å€™é€‰æ·»ä¸Šæ¼‚äº®çš„å›¾æ ‡ã€‚

#+BEGIN_SRC emacs-lisp
(use-package all-the-icons-completion
  :ensure t
  :hook ((after-init . all-the-icons-completion-mode)
         (marginalia-mode . all-the-icons-completion-marginalia-setup))
  )
#+END_SRC

** embark

[[https://github.com/oantolin/embark][embark]] æ’ä»¶æä¾›äº†ä¸€ç³»åˆ—çš„è¿·ä½ ç¼“å†²åŒºçš„ç±»ä¼¼å³é”®æœºåˆ¶çš„å¢å¼ºã€‚

#+BEGIN_SRC emacs-lisp
(use-package embark
  :ensure t
  :bind (([remap describe-bindings] . embark-bindings)
         ("C-'" . embark-act)
         :map minibuffer-local-map
         :map minibuffer-local-completion-map
         ("TAB" . minibuffer-force-complete)
         :map embark-file-map
         ("E" . consult-file-externally)      ; Open file externally, or `we' in Ranger
         ("O" . consult-directory-externally) ; Open directory externally
         )
  :init
  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)
  :config
  ;; Show Embark actions via which-key
  (setq embark-action-indicator
        (lambda (map)
          (which-key--show-keymap "Embark" map nil nil 'no-paging)
          #'which-key--hide-popup-ignore-command)
        embark-become-indicator embark-action-indicator)

  ;; open directory
  (defun consult-directory-externally (file)
    "Open directory externally using the default application of the system."
    (interactive "fOpen externally: ")
    (if (and (eq system-type 'windows-nt)
             (fboundp 'w32-shell-execute))
        (shell-command-to-string (encode-coding-string (replace-regexp-in-string "/" "\\\\"
                                                                                 (format "explorer.exe %s" (file-name-directory (expand-file-name file)))) 'gbk))
      (call-process (pcase system-type
    	              ('darwin "open")
    	              ('cygwin "cygstart")
    	              (_ "xdg-open"))
    	            nil 0 nil
    	            (file-name-directory (expand-file-name file)))))

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))
  )

(use-package embark-consult
  :ensure t
  :hook (embark-collect-mode . consult-preview-at-point-mode))
#+END_SRC

** init-completion.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-completion)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-completion.el ends here
#+END_SRC

* init-dired.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-dired.el :mkdirp yes
:END:

Emacsæ–‡ä»¶ç®¡ç†è®¾ç½®ã€‚

** init-dired.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-dired.el --- Dired settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** DiredåŸºç¡€é…ç½®

#+BEGIN_SRC emacs-lisp
(use-package dired
  :ensure nil
  :bind (:map dired-mode-map
              ("C-<return>" . xah-open-in-external-app)
              ("W" . dired-copy-path)
              )
  :config
  ;; Enable the disabled dired commands
  (put 'dired-find-alternate-file 'disabled nil)

  ;; open files via external program based on file types, See:
  ;; https://emacs.stackexchange.com/questions/3105/how-to-use-an-external-program-as-the-default-way-to-open-pdfs-from-emacs
  (defun xdg-open (filename)
    (interactive "fFilename: ")
    (let ((process-connection-type))
      (start-process "" nil (cond ((eq system-type 'gnu/linux) "xdg-open")
                                  ((eq system-type 'darwin) "open")
                                  ((eq system-type 'windows-nt) "start")
                                  (t "")) (expand-file-name filename))))
  ;; open files via external program when using find-file
  (defun find-file-auto (orig-fun &rest args)
    (let ((filename (car args)))
      (if (cl-find-if
           (lambda (regexp) (string-match regexp filename))
           '(
             ;; "\\.html?\\'"
             "\\.xlsx?\\'"
             "\\.pptx?\\'"
             "\\.docx?\\'"
             "\\.mp4\\'"
             "\\.app\\'"
             ))
          (xdg-open filename)
        (apply orig-fun args))))
  (advice-add 'find-file :around 'find-file-auto)

  (defun dired-copy-path ()
    "In dired, copy file path to kill-buffer.
At 2nd time it copy current directory to kill-buffer."
    (interactive)
    (let (path)
      (setq path (dired-file-name-at-point))
      (if (string= path (current-kill 0 1)) (setq path (dired-current-directory)))
      (message path)
      (kill-new path)))

  (defun xah-open-in-external-app (&optional @fname)
    "Open the current file or dired marked files in external app.
The app is chosen from your OS's preference.

When called in emacs lisp, if @fname is given, open that.

URL `http://ergoemacs.org/emacs/emacs_dired_open_file_in_ext_apps.html'
Version 2019-11-04"
    (interactive)
    (let* (
           ($file-list
            (if @fname
                (progn (list @fname))
              (if (or (string-equal major-mode "dired-mode")
                      (string-equal major-mode "dirvish-mode"))
                  (dired-get-marked-files)
                (list (buffer-file-name)))))
           ($do-it-p (if (<= (length $file-list) 5)
                         t
                       (y-or-n-p "Open more than 5 files? "))))
      (when $do-it-p
        (cond
         ((string-equal system-type "windows-nt")
          (mapc
           (lambda ($fpath)
             (w32-shell-execute "open" $fpath)) $file-list))
         ((string-equal system-type "darwin")
          (mapc
           (lambda ($fpath)
             (shell-command
              (concat "open " (shell-quote-argument $fpath))))  $file-list))
         ((string-equal system-type "gnu/linux")
          (mapc
           (lambda ($fpath) (let ((process-connection-type nil))
                              (start-process "" nil "xdg-open" $fpath))) $file-list))))))
  :custom
  ;; (dired-recursive-deletes 'always)
  (delete-by-moving-to-trash t)
  (dired-dwim-target t)
  (dired-bind-vm nil)
  (dired-bind-man nil)
  (dired-bind-info nil)
  (dired-auto-revert-buffer t)
  (dired-hide-details-hide-symlink-targets nil)
  (dired-kill-when-opening-new-dired-buffer t)
  (dired-listing-switches "-AFhlv"))

(use-package dired-aux
  :ensure nil
  :bind (:map dired-mode-map
              ("C-c +" . dired-create-empty-file))
  :config
  ;; with the help of `evil-collection', P is bound to `dired-do-print'.
  (define-advice dired-do-print (:override (&optional _))
    "Show/hide dotfiles."
    (interactive)
    (if (or (not (boundp 'dired-dotfiles-show-p)) dired-dotfiles-show-p)
        (progn
          (setq-local dired-dotfiles-show-p nil)
          (dired-mark-files-regexp "^\\.")
          (dired-do-kill-lines))
      (revert-buffer)
      (setq-local dired-dotfiles-show-p t)))
  :custom
  (dired-isearch-filenames 'dwim)
  (dired-create-destination-dirs 'ask)
  (dired-vc-rename-file t))

(use-package dired-x
  :ensure nil
  :hook (dired-mode . dired-omit-mode)
  :init
  (setq dired-guess-shell-alist-user `((,(rx "."
                                             (or
                                              ;; Videos
                                              "mp4" "avi" "mkv" "flv" "ogv" "ogg" "mov"
                                              ;; Music
                                              "wav" "mp3" "flac"
                                              ;; Images
                                              "jpg" "jpeg" "png" "gif" "xpm" "svg" "bmp"
                                              ;; Docs
                                              "pdf" "md" "djvu" "ps" "eps" "doc" "docx" "xls" "xlsx" "ppt" "pptx")
                                             string-end)
                                        ,(cond ((eq system-type 'gnu/linux) "xdg-open")
                                               ((eq system-type 'darwin) "open")
                                               ((eq system-type 'windows-nt) "start")
                                               (t "")))))
  :custom
  (dired-omit-verbose nil)
  (dired-omit-files (rx string-start
                        (or ".DS_Store"
                            ".cache"
                            ".vscode"
                            ".ccls-cache" ".clangd")
                        string-end))
  ;; Dont prompt about killing buffer visiting delete file
  (dired-clean-confirm-killing-deleted-buffers nil)
  )
#+END_SRC

** diredflå¤šå½©ç¾åŒ–

é»˜è®¤çš„Diredåªæœ‰ä¸¤ç§é¢œè‰²ä»¥åŒºåˆ†æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [[https://github.com/purcell/diredfl][diredfl]] æ’ä»¶è®©Diredå˜å¾—æ›´åŠ å¤šå½©ä¸€äº›ï¼š

#+BEGIN_SRC emacs-lisp
(use-package diredfl
  :ensure t
  :hook (dired-mode . diredfl-mode))
#+END_SRC

** all-the-icons-diredå›¾æ ‡ç¾åŒ–

æˆ‘ä»¬é€šè¿‡ [[https://github.com/jtbm37/all-the-icons-dired][all-the-icons-dired]] æ’ä»¶ç»™Diredæ·»åŠ å¥½çœ‹çš„å›¾æ ‡ã€‚

#+BEGIN_SRC emacs-lisp
(use-package all-the-icons-dired
  :ensure t
  :hook (dired-mode . all-the-icons-dired-mode)
  )
#+END_SRC

** dirvishæ–‡ä»¶ç®¡ç†

[[https://github.com/alexluigit/dirvish][dirvish]] æ˜¯åœ¨DiredåŸºç¡€ä¹‹ä¸Šçš„æ–‡ä»¶ç®¡ç†å¢å¼ºæ’ä»¶ã€‚éœ€è¦å®‰è£… =poppler= æ¥é¢„è§ˆPDFï¼›å®‰è£… =ffmpegthumbnailer= æ¥é¢„è§ˆè§†é¢‘ã€‚

#+BEGIN_SRC emacs-lisp
(use-package dirvish
  :ensure t
  :hook (after-init . dirvish-override-dired-mode)
  :bind (:map dired-mode-map
         ("TAB" . dirvish-toggle-subtree)
         ("SPC" . dirvish-show-history)
         ("*"   . dirvish-mark-menu)
         ("r"   . dirvish-roam)
         ("b"   . dirvish-goto-bookmark)
         ("f"   . dirvish-file-info-menu)
         ("M-n" . dirvish-go-forward-history)
         ("M-p" . dirvish-go-backward-history)
         ("M-s" . dirvish-setup-menu)
         ("M-f" . dirvish-toggle-fullscreen)
         ([remap dired-sort-toggle-or-edit] . dirvish-quicksort)
         ([remap dired-do-redisplay] . dirvish-ls-switches-menu)
         ([remap dired-summary] . dirvish-dispatch)
         ([remap dired-do-copy] . dirvish-yank-menu)
         ([remap mode-line-other-buffer] . dirvish-other-buffer))
  :config
  (dirvish-peek-mode)
  (setq dirvish-hide-details t)
  ;; open mp4 file via external program which is mpv here.
  (add-to-list 'mailcap-mime-extensions '(".mp4" . "video/mp4"))
  (add-list-to-list 'dirvish-open-with-programs '(
                                                  (("html") . ("open" "%f"))
                                                  (("xlsx") . ("open" "%f"))
                                                  (("pptx") . ("open" "%f"))
                                                  (("docx") . ("open" "%f"))
                                                  (("md")   . ("open" "%f"))
                                                  ))
  :custom
  (dirvish-menu-bookmarks '(("h" "~/"             "Home")
                            ("d" "~/Downloads/"   "Downloads")
                            ("e" "~/.emacs.d.default/"    "Emacs")
                            ("o" "~/org/"         "org")
                            ("i" "~/iCloud/"      "iCloud")
                            ;; ("t" "~/.local/share/Trash/files/" "TrashCan")
                            ))
  (dirvish-mode-line-format '(:left
                              (sort file-time " " file-size symlink) ; it's ok to place string inside
                              :right
                              ;; For `dired-filter' users, replace `omit' with `filter' segment defined below
                              (omit yank index)))
  (dirvish-attributes '(subtree-state
                        file-size
                        vc-state
                        git-msg
                        file-time
                        ;; all-the-icons
                        ))
  )
#+END_SRC

** init-dired.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-dired)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-dired.el ends here
#+END_SRC

* init-tools.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-tools.el :mkdirp yes
:END:

** init-tools.el æ–‡ä»¶å¤´

#+BEGIN_SRC emacs-lisp
;;; init-tools.el --- Tools settings -*- lexical-binding: t -*-
;;; Commentary: Useful tools to make Emacs efficient!

;;; Code:

#+END_SRC

** helpfulå¸®åŠ©å¢å¼º

[[https://github.com/Wilfred/helpful][helpful]] æ’ä»¶æä¾›äº†å¸®åŠ©å¢å¼ºã€‚

#+begin_src emacs-lisp
(use-package helpful
  :ensure t
  :commands (helpful-callable helpful-variable helpful-command helpful-key helpful-mode)
  :bind (([remap describe-command] . helpful-command)
         ("C-h f" . helpful-callable)
         ("C-h v" . helpful-variable)
         ("C-h s" . helpful-symbol)
         ("C-h S" . describe-syntax)
         ("C-h m" . describe-mode)
         ("C-h F" . describe-face)
         ([remap describe-key] . helpful-key))
  )
#+end_src

** which-keyå¿«æ·é”®

[[https://github.com/justbur/emacs-which-key][which-key]] æ’ä»¶å°†æç¤ºå¿«æ·é”®ã€‚

#+begin_src emacs-lisp
(use-package which-key
  :ensure t
  :hook (after-init . which-key-mode)
  :config
  (which-key-add-key-based-replacements
    "C-c !" "flycheck"
    "C-c @" "hideshow"
    "C-c i" "ispell"
    "C-c t" "hl-todo"
    "C-x a" "abbrev"
    "C-x n" "narrow"
    "C-x t" "tab")
  :custom
  (which-key-idle-delay 0.7)
  (which-key-add-column-padding 1))
#+end_src

** init-tools.el æ–‡ä»¶å°¾

#+BEGIN_SRC emacs-lisp

(provide 'init-tools)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-tools.el ends here
#+END_SRC

* init-dev.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-dev.el :mkdirp yes
:END:

** init-dev.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-dev.el --- Development settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** vcè®¾ç½®

Emacsè‡ªå¸¦çš„vcè®¾ç½®ã€‚

#+BEGIN_SRC emacs-lisp
(use-package vc
  :ensure nil
  :custom
  ;; æ‰“å¼€é“¾æ¥æ–‡ä»¶æ—¶ï¼Œä¸è¿›è¡Œè¿½é—®
  (vc-follow-symlinks t)
  (vc-allow-async-revert t)
  (vc-handled-backends '(Git)))
#+END_SRC

** magitç‰ˆæœ¬ç®¡ç†

[[https://github.com/magit/magit][magit]] æ˜¯Emacsé‡Œçš„å¦ä¸€ä¸ªæ€æ‰‹çº§åº”ç”¨ï¼å¯ä»¥ç›´æ¥åœ¨Emacsé‡Œè¿›è¡ŒåŸºäºgitçš„ç‰ˆæœ¬ç®¡ç†ã€‚

#+begin_src emacs-lisp
(use-package magit
  :ensure t
  :hook (git-commit-mode . flyspell-mode)
  :bind (("C-x g"   . magit-status)
         ("C-x M-g" . magit-dispatch)
         ("C-c M-g" . magit-file-dispatch))
  :custom
  (magit-diff-refine-hunk t)
  (magit-ediff-dwim-show-on-hunks t))
#+end_src

** diff-hlé«˜äº®æ˜¾ç¤ºä¿®æ”¹çš„éƒ¨åˆ†

[[https://github.com/dgutov/diff-hl][diff-hl]] æ’ä»¶å¯ä»¥åœ¨å·¦ä¾§é«˜äº®æ˜¾ç¤ºç›¸å¯¹äºè¿œç¨‹ä»“åº“çš„ä¿®æ”¹éƒ¨åˆ†ã€‚

#+BEGIN_SRC emacs-lisp
(use-package diff-hl
  :ensure t
  :hook ((dired-mode         . diff-hl-dired-mode-unless-remote)
         (magit-pre-refresh  . diff-hl-magit-pre-refresh)
         (magit-post-refresh . diff-hl-magit-post-refresh))
  :init
  (global-diff-hl-mode t)
  :config
  ;; When Emacs runs in terminal, show the indicators in margin instead.
  (unless (display-graphic-p)
    (diff-hl-margin-mode)))
#+END_SRC

** magit-deltaå¢å¼ºgit diff

[[https://github.com/dandavison/magit-delta][magit-delta]] æ’ä»¶å¯ä»¥é€šè¿‡ =git-delta= æ¥æ›´ä¼˜åŒ–çš„æ–¹å¼æ˜¾ç¤ºdiffå†…å®¹ï¼ˆéœ€è¦æå‰å®‰è£… =brew install git-delta= ï¼‰ã€‚

#+BEGIN_SRC emacs-lisp
(use-package magit-delta
  :ensure t
  :hook (magit-mode . magit-delta-mode)
  :config
  (setq magit-delta-hide-plus-minus-markers nil)
  )
#+END_SRC

** parené«˜äº®åŒ¹é…çš„æ‹¬å·

#+BEGIN_SRC emacs-lisp
(use-package paren
  :ensure nil
  :hook (after-init . show-paren-mode)
  :custom
  (show-paren-when-point-inside-paren t)
  (show-paren-when-point-in-periphery t))
#+END_SRC

** rainbow-delimeterså¤šå½©æ‹¬å·

[[https://github.com/Fanael/rainbow-delimiters][rainbow-delimiters]] æ’ä»¶å°†å¤šå½©æ˜¾ç¤ºæ‹¬å·ç­‰åˆ†éš”ç¬¦ã€‚

#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :ensure t
  :hook (prog-mode . rainbow-delimiters-mode))
#+end_src

** emacs-lispè¯­è¨€è®¾ç½®

#+BEGIN_SRC emacs-lisp
(use-package elisp-mode
  :ensure nil
  :after org
  :bind (:map emacs-lisp-mode-map
              ("C-c C-b" . eval-buffer)
              ("C-c C-c" . eval-to-comment)
              :map lisp-interaction-mode-map
              ("C-c C-c" . eval-to-comment)
              :map org-mode-map
              ("C-c C-;" . eval-to-comment)
              )
  :init
  ;; for emacs-lisp org babel
  (add-to-list 'org-babel-default-header-args:emacs-lisp
             '(:results . "value pp"))
  :config
  (defconst eval-as-comment-prefix " â‡’ ")
  (defun eval-to-comment (&optional arg)
    (interactive "P")
    ;; (if (not (looking-back ";\\s*"))
    ;;     (call-interactively 'comment-dwim))
    (call-interactively 'comment-dwim)
    (progn
      (search-backward ";")
      (forward-char 1))
    (delete-region (point) (line-end-position))
    (save-excursion
      (let ((current-prefix-arg '(4)))
        (call-interactively 'eval-last-sexp)))
    (insert eval-as-comment-prefix)
    (end-of-line 1))
  )
#+END_SRC

** Pythonè¯­è¨€è®¾ç½®

Pythonè¯­è¨€çš„è®¾ç½®ã€‚[[https://github.com/paetzke/py-autopep8.el][py-autopep8.el]] æ’ä»¶å¯ä»¥è®©æˆ‘ä»¬åœ¨ç¼–å†™Pythonä¿å­˜æ–‡ä»¶çš„æ—¶å€™ï¼Œè‡ªåŠ¨ä»¥ =PEP8= æ ‡å‡†åšæ ¼å¼ç¾åŒ–ï¼ˆéœ€è¦æå‰ =brew install autopep8= ï¼‰ã€‚

#+BEGIN_SRC emacs-lisp
(use-package python
  :ensure nil
  :mode ("\\.py\\'" . python-mode)
  :init
  (add-list-to-list 'org-babel-default-header-args:python '((:results . "output pp")
                                                            (:noweb   . "yes")
                                                            (:session . "py")
                                                            (:async   . "yes")
                                                            (:exports . "both")
                                                            ))
  :config
  (setq python-indent-offset 4)
  ;; Disable readline based native completion
  (setq python-shell-completion-native-enable nil)
  (setq python-indent-guess-indent-offset-verbose nil)
  (setq python-shell-interpreter "python3"
        python-shell-prompt-detect-failure-warning nil)
  ;; disable native completion
  (add-to-list 'python-shell-completion-native-disabled-interpreters "python3")
  ;; Env vars
  (with-eval-after-load 'exec-path-from-shell
    (exec-path-from-shell-copy-env "PYTHONPATH"))
  )

;; need to pip install autopep8 first
(use-package py-autopep8
  :ensure t
  :hook (python-mode . py-autopep8-mode)
  )
#+END_SRC

** Shellè¯­è¨€è®¾ç½®

#+BEGIN_SRC emacs-lisp
(use-package sh-script
  :ensure nil
  :mode (("\\.sh\\'"     . sh-mode)
         ("zshrc"        . sh-mode)
         ("zshenv"       . sh-mode)
         ("/PKGBUILD\\'" . sh-mode))
  :hook (sh-mode . sh-mode-setup)
  :bind (:map sh-mode-map
         ("C-c C-e" . sh-execute-region))
  :init
  ;; for org babel
  (add-list-to-list 'org-babel-default-header-args:shell
                  '((:results . "output")
                    (:tangle  . "no")))
  :config
  (defun sh-mode-setup ()
    (add-hook 'after-save-hook #'executable-make-buffer-file-executable-if-script-p nil t))
  :custom
  (sh-basic-offset 2)
  (sh-indentation 2))
#+END_SRC

** init-dev.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-dev)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-dev.el ends here
#+END_SRC

* init-mail.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-mail.el :mkdirp yes
:END:

Emacsé‚®ä»¶è®¾ç½®ã€‚

** init-mail.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-mail.el --- Mail settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** notmuché‚®ä»¶ç³»ç»Ÿ

notmuché‚®ä»¶ç³»ç»Ÿé…ç½®ã€‚

#+BEGIN_SRC emacs-lisp
(use-package ol-notmuch
  :ensure t
  )

(use-package notmuch
  :ensure t
  :commands notmuch
  :hook ((window-setup . notmuch)
         (notmuch-hello-refresh . notmuch-unread-count))
  :bind (("\e\em" . notmuch)
         ("C-x m" . notmuch-mua-new-mail) ; override `compose mail'
         :map notmuch-hello-mode-map
         ("q"     . quit-window)
         :map notmuch-show-mode-map
         ("C-c f" . my/capture-mail-follow-up)
         ("C-c r" . my/capture-mail-read-later)
         :map notmuch-search-mode-map
         ("/"     . notmuch-search-filter)
         ("C-c f" . my/capture-mail-follow-up))
  :init
  (setq notmuch-search-oldest-first nil) ; newest on the top
  :config
  ;; è®¾ç½®notmuché‚®ä»¶å¿«é€Ÿè®°å½•çš„æ¨¡æ¿
  (require 'org-capture)
  (add-to-list 'org-capture-templates
               '("e" "Email follow up" entry
                 (file+headline "mail.org" "Follow Up")
                 "* TODO [#A] %:subject :mail:\nSCHEDULED: %t\nDEADLINE: %(org-insert-time-stamp (org-read-date nil t \"+2d\"))\n\n%a%?"
                 :empty-lines-after 1
                 :prepend t
                 :immediate-finish t
                 :jump-to-captured t
                 ))
  (add-to-list 'org-capture-templates-contexts
               '("e" ((in-mode . "notmuch-search-mode")
                      (in-mode . "notmuch-show-mode"))))

  ;; åœ¨é‚®ä»¶ç•Œé¢å¿«é€Ÿè®°å½•éœ€è¦è·Ÿè¿›çš„é‚®ä»¶
  (defun my/capture-mail-follow-up ()
    (interactive)
    (call-interactively 'org-store-link)
    (org-capture nil "e"))

  ;; custom UI
  (setq notmuch-show-logo t)
  (setq notmuch-column-control 1.0)
  (setq notmuch-hello-recent-searches-max 20)
  (setq notmuch-hello-thousands-separator ",")
  (setq notmuch-hello-sections '(notmuch-hello-insert-header
                                 notmuch-hello-insert-saved-searches
                                 notmuch-hello-insert-alltags
                                 notmuch-hello-insert-footer))
  (setq notmuch-show-all-tags-list t)

  ;; set saved searches, use `j' to jump to the search
  (setq notmuch-saved-searches '(
                                 (:name "all"
                                        :query "*"
                                        :sort-order newest-first
                                        :key "l")

                                 (:name "archived"
                                        :query "tag:archived"
                                        :sort-order newest-first
                                        :key "A")

                                 (:name "inbox"
                                        :query "tag:inbox"
                                        :sort-order newest-first
                                        :key "i")

                                 (:name "sent"
                                        :query "tag:sent"
                                        :sort-order newest-first
                                        :key "s")
                                 ))
  (setq notmuch-archive-tags '("-inbox" "+archived"))

  ;; Email composition
  (setq notmuch-mua-user-agent-function #'notmuch-mua-user-agent-full)

  ;; Reading messages
  (setq notmuch-wash-citation-lines-prefix 6) ; default is 3
  (setq notmuch-wash-citation-lines-suffix 6)
  (setq notmuch-unthreaded-show-out nil)
  (setq notmuch-message-headers '("To" "Cc" "Subject" "Date"))

  ;; notmuch notifications on mode-line based from notmuch-unread-mode, refer to:
  ;; https://www.reddit.com/r/emacs/comments/esxjh5/my_notmuch_email_count_display_in_modeline/
  (defvar notmuch-unread-mode-line-string "")
  (defvar notmuch-unread-email-count nil)
  (defconst my-mode-line-map (make-sparse-keymap))

  (defun notmuch-unread-count ()
    (setq notmuch-unread-email-count (string-to-number (replace-regexp-in-string "\n" "" (notmuch-command-to-string "count" "tag:unread"))))
    (if (eq notmuch-unread-email-count 0)
        (setq notmuch-unread-mode-line-string (format "ïƒ  0 "))
      (setq notmuch-unread-mode-line-string (format "ïƒ  %d " notmuch-unread-email-count)))
    (force-mode-line-update))

  (defun notmuch-open-emails ()
    (interactive)
    (if (eq notmuch-unread-email-count 0) (notmuch-search "tag:inbox") (notmuch-search "tag:unread")))

  (setq global-mode-string
        (append global-mode-string (list '(:eval (propertize notmuch-unread-mode-line-string 'help-echo "notmuch emails" 'mouse-face 'mode-line-highlight 'local-map my-mode-line-map)))))

  (define-key my-mode-line-map
              (vconcat [mode-line down-mouse-1])
              (cons "hello" 'notmuch-open-emails))

  ;; æ¯ä¸‰åˆ†é’Ÿåˆ·æ–°ä¸€ä¸‹notmuchï¼Œåœ¨åˆ·æ–°çš„æ—¶å€™ä¼šæ‰§è¡Œ `notmuch-unread-count' hook
  ;; æ¥æ‰§è¡ŒçŠ¶æ€æ çš„é‚®ä»¶æ•°é‡æ›´æ–°
  (run-at-time t 180 #'notmuch-refresh-all-buffers)
  )
#+END_SRC

** é‚®ä»¶å‘é€é…ç½®

#+BEGIN_SRC emacs-lisp
(use-package message
  :ensure nil
  :hook ((message-mode . auto-fill-mode)
         (message-mode . (lambda () (display-line-numbers-mode 0)))
         (message-mode . turn-on-orgtbl)
         )
  ;; :bind (:map message-mode-map ("TAB" . message-display-abbrev))
  :config
  ;; add Cc and Bcc headers to the message buffer
  (setq message-default-mail-headers "Cc: \nBcc: \n")
  ;; change the directory to store the sent mail and mkdir sent ahead
  (setq message-directory "~/Mail/")
  (setq message-auto-save-directory "~/Mail/drafts/")
  :custom
  ;; make sure `user-full-name' and `user-mail-address' are configed
  (message-kill-buffer-on-exit t)
  (message-mail-alias-type 'ecomplete)
  (message-send-mail-function #'message-use-send-mail-function)
  (message-signature (concat "Best regards,\n" user-full-name))
  )

(use-package sendmail
  :ensure nil
  :defer t
  :custom
  (send-mail-function 'sendmail-send-it)
  ;; msmtp config
  (sendmail-program "/usr/local/bin/msmtp")
  (mail-specify-envelope-from t)
  (message-sendmail-envelope-from 'header)
  (mail-envelope-from 'header)
  )
#+END_SRC

** é‚®ä»¶ç³»ç»Ÿé€šçŸ¥

#+BEGIN_SRC emacs-lisp
(use-package emacs
  :ensure nil
  :hook (notmuch-hello-refresh . notmuch-hello-refresh-status-message)
  :config
  (defvar notmuch-hello-refresh-count 0)
  (defun notmuch-hello-refresh-status-message ()
    (let* ((new-count
            (string-to-number
             (car (process-lines notmuch-command "count"))))
           (diff-count (- new-count notmuch-hello-refresh-count)))
      (cond
       ((= notmuch-hello-refresh-count 0)
        (progn
          (message "You have new messages.")
          (notify-send :title "Notmuch email"
                       :body (concat "You have " (notmuch-hello-nice-number new-count) " messages.")
                       :timeout 5
                       :urgency 'critical)
          ))
       ((> diff-count 0)
        (progn
          (message "You have new messages.")
          (notify-send :title "Notmuch email"
                       :body (concat "You have " (notmuch-hello-nice-number diff-count) " more messages since last refresh.")
                       :timeout 5
                       :urgency 'critical)
          ))
       ((< diff-count 0)
        (progn
          (message "You have new messages.")
          (notify-send :title "Notmuch email"
                       :body (concat "You have " (notmuch-hello-nice-number (- diff-count)) " fewer messages since last refresh.")
                       :timeout 5
                       :urgency 'critical)
          )))
      (setq notmuch-hello-refresh-count new-count)))
  )
#+END_SRC

** init-mail.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-mail)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-mail.el ends here
#+END_SRC

* init-rss.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-rss.el :mkdirp yes
:END:

Emacsçš„RSSæ–°é—»é˜…è¯»è®¾ç½®

** init-rss.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-rss.el --- RSS settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** elfeed

[[https://github.com/skeeto/elfeed][elfeed]] æ’ä»¶æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„RSSæ–°é—»é˜…è¯»å®¢æˆ·ç«¯ã€‚

#+BEGIN_SRC emacs-lisp
(use-package elfeed
  :ensure t
  :hook ((elfeed-new-entry . (lambda () (elfeed-make-tagger :feed-url "video" :add '(video))
                               (elfeed-make-tagger :entry-title "å›¾å¦" :add '(pic)))))
  :bind (("\e\e n" . elfeed)
         :map elfeed-search-mode-map
         ("g" . elfeed-update)
         ("G" . elfeed-search-update--force)
         ("o" . elfeed-default-browser-open)
         :map elfeed-show-mode-map
         ("M-v" . scroll-down-command)
         ("j" . scroll-up-line)
         ("k" . scroll-down-line))
  :config
  (setq elfeed-db-directory "~/.elfeed")
  ;; capture template for elfeed
  (with-eval-after-load 'org-capture
    (add-to-list 'org-capture-templates '("r" "Elfeed RSS" entry (file+headline "capture.org" "Elfeed")
                                          "* %:elfeed-entry-title :READ:\n%?\n%a"
                                          :empty-lines-after 1
                                          :prepend t))
    (add-to-list 'org-capture-templates-contexts '("r" ((in-mode . "elfeed-show-mode")
                                                        (in-mode . "elfeed-search-mode")))))
  ;; ================================
  ;; open entry with browser
  ;; ================================
  (defun elfeed-default-browser-open (&optional use-generic-p)
    "open with default browser"
    (interactive "P")
    (let ((entries (elfeed-search-selected)))
      (cl-loop for entry in entries
               do (elfeed-untag entry 'unread)
               when (elfeed-entry-link entry)
               do (browse-url it))
      (mapc #'elfeed-search-update-entry entries)
      (unless (use-region-p) (forward-line))))
  :custom
  (elfeed-feeds '(
                  ("https://planet.emacslife.com/atom.xml" emacs)
                  ("http://www.dapenti.com/blog/rss2.asp?name=xilei" news)
                  ("https://remacs.cc/index.xml" emacs product)
                  ))
  (elfeed-use-curl t)
  (elfeed-curl-max-connections 10)
  (elfeed-enclosure-default-dir "~/Downloads/")
  (elfeed-search-filter "@4-months-ago +")
  (elfeed-sort-order 'descending)
  (elfeed-search-clipboard-type 'CLIPBOARD)
  (elfeed-search-title-max-width 100)
  (elfeed-search-title-min-width 30)
  (elfeed-search-trailing-width 25)
  (elfeed-show-truncate-long-urls t)
  (elfeed-show-unique-buffers t)
  (elfeed-search-date-format '("%F %R" 16 :left))
  )
#+END_SRC

** elfeed-goodiesç»™elfeedä¼˜åŒ–å¢å¼º

æˆ‘ä»¬é€šè¿‡ [[https://github.com/jeetelongname/elfeed-goodies][elfeed-goodies]] æ’ä»¶ç»™ elfeed è¿›è¡Œä¼˜åŒ–å¢å¼ºï¼š

#+BEGIN_SRC emacs-lisp
(use-package elfeed-goodies
  :ensure t
  :hook (after-init . elfeed-goodies/setup)
  :config
  ;; set elfeed show entry switch function
  (setq elfeed-show-entry-switch #'elfeed-goodies/switch-pane) ; switch-to-buffer, pop-to-buffer
  )
#+END_SRC

** init-rss.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-rss)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-rss.el ends here
#+END_SRC

* init-shell.el
:PROPERTIES:
:HEADER-ARGS: :tangle lisp/init-shell.el :mkdirp yes
:END:

Emacsé‡Œçš„shellè®¾ç½®ã€‚

** init-shell.el æ–‡ä»¶å¤´
#+BEGIN_SRC emacs-lisp
;;; init-shell.el --- (E)shell settings -*- lexical-binding: t -*-
;;; Commentary:

;;; Code:

#+END_SRC

** eshell åŸºæœ¬é…ç½®

#+BEGIN_SRC emacs-lisp
(use-package eshell
  :ensure nil
  :functions eshell/alias
  :hook ((eshell-mode . (lambda ()
                          (term-mode-common-init)
                          ;; Remove cmd args word by word
                          (modify-syntax-entry ?- "w")
                          (visual-line-mode 1)
                          (setenv "PAGER" "cat")))
         )
  :config
  (defun term-mode-common-init ()
  "The common initialization for term."
  (setq-local scroll-margin 0)
  (setq-local truncate-lines t)
  )
  
  ;; åœ¨Emacsé‡Œè¾“å…¥viï¼Œç›´æ¥åœ¨bufferé‡Œæ‰“å¼€æ–‡ä»¶
  (defalias 'eshell/vi 'find-file)
  (defalias 'eshell/vim 'find-file)

  ;; è¯­æ³•é«˜äº®æ˜¾ç¤º
  (defun eshell/bat (file)
    "cat FILE with syntax highlight."
    (with-temp-buffer
      (insert-file-contents file)
      (let ((buffer-file-name file))
        (delay-mode-hooks
          (set-auto-mode)
          (font-lock-ensure)))
      (buffer-string)))
  (defalias 'eshell/cat 'eshell/bat)

  ;; äº¤äº’å¼è¿›å…¥ç›®å½•
  (defun eshell/z ()
    "cd to directory with completion."
    (let ((dir (completing-read "Directory: " (ring-elements eshell-last-dir-ring) nil t)))
      (eshell/cd dir)))

  ;; æŸ¥æ‰¾æ–‡ä»¶
  (defun eshell/f (filename &optional dir)
    "Search for files matching FILENAME in either DIR or the
current directory."
    (let ((cmd (concat
                ;; using find
                (executable-find "find")
                " " (or dir ".")
                " -not -path '*/.git*'"            ; ignore .git directory
                " -and -not -path 'build'"         ; ignore cmake build directory
                " -and -not -path '*/eln-cache*'"  ; ignore eln cache
                " -and -type f -and -iname "
                "'*" filename "*'")))
      (eshell-command-result cmd)))

  :custom
  (eshell-banner-message
   '(format "%s %s\n"
            (propertize (format " %s " (string-trim (buffer-name)))
                        'face 'mode-line-highlight)
            (propertize (current-time-string)
                        'face 'font-lock-keyword-face)))
  (eshell-scroll-to-bottom-on-input 'all)
  (eshell-scroll-to-bottom-on-output 'all)
  (eshell-kill-on-exit t)
  (eshell-kill-processes-on-exit t)
  ;; Don't record command in history if starts with whitespace
  (eshell-input-filter 'eshell-input-filter-initial-space)
  (eshell-error-if-no-glob t)
  (eshell-glob-case-insensitive t)
  ;; set scripts
  (eshell-rc-script (locate-user-emacs-file "etc/eshell/profile"))
  (eshell-login-script (locate-user-emacs-file "etc/eshell/login"))
  )
#+END_SRC

** eshell alias è®¾ç½®

#+BEGIN_SRC text :tangle etc/eshell/aliases
alias ff find-file $1
alias fo find-file-other-window $1
alias d dired $1
alias ll ls -alh
alias l. ls -dh .*
alias up eshell-up $1
alias pk eshell-up-peek $1
alias less view-file $1
alias more view-file $1
#+END_SRC

** eshell é‡Œçš„ C-d

è®© =C-d= æ›´æ™ºèƒ½ï¼š

#+BEGIN_SRC emacs-lisp
(use-package em-rebind
  :ensure nil
  :commands eshell-delchar-or-maybe-eof)

(use-package esh-mode
  :ensure nil
  :bind (:map eshell-mode-map
              ("C-d" . eshell-delchar-or-maybe-eof)
              ("C-r" . consult-history)
              ("C-l" . eshell/clear))
  )
#+END_SRC

** Eshell çš„å‘½ä»¤å†å²

#+BEGIN_SRC emacs-lisp
(use-package em-hist
  :ensure nil
  :defer t
  :custom
  (eshell-history-size 1024)
  (eshell-hist-ignoredups t)
  (eshell-save-history-on-exit t))
#+END_SRC

** æœ‰äº›å‘½ä»¤ä½¿ç”¨ term

æœ‰ä¸€äº›å‘½ä»¤å¦‚ topï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ termï¼š

#+BEGIN_SRC emacs-lisp
;; following commands will run on term instead
(use-package em-term
  :ensure nil
  :defer t
  :custom
  (eshell-visual-commands '("top" "htop" "less" "more"))
  (eshell-visual-subcommands '(("git" "help" "lg" "log" "diff" "show")))
  (eshell-visual-options '(("git" "--help" "--paginate")))
  (eshell-destroy-buffer-when-process-dies t))
#+END_SRC

** eshell-git-prompt å‘½ä»¤è¡Œä¸»é¢˜

[[https://github.com/xuchunyang/eshell-git-prompt][eshell-git-prompt]] æ’ä»¶æä¾›äº†æ•°ä¸ªå¥½çœ‹çš„ Eshell å‘½ä»¤è¡Œä¸»é¢˜ã€‚

#+BEGIN_SRC emacs-lisp
(use-package eshell-git-prompt
  :ensure t
  :after esh-mode
  :custom-face
  (eshell-git-prompt-multiline2-dir-face ((t (:foreground "#c09035" :bold t))))
  :config
  (eshell-git-prompt-use-theme 'multiline2)
  )
#+END_SRC

** eshell-syntax-highlighting è¯­æ³•é«˜äº®

[[https://github.com/akreisher/eshell-syntax-highlighting][eshell-syntax-highlighting]] æ’ä»¶ä¸ºEshellæä¾›è¯­æ³•é«˜äº®ã€‚

#+BEGIN_SRC emacs-lisp
(use-package eshell-syntax-highlighting
  :after esh-mode
  :ensure t
  :hook (eshell-mode . eshell-syntax-highlighting-global-mode)
  :custom-face
  (eshell-syntax-highlighting-shell-command-face ((t (:foreground "#7cc77f" :bold t))))
  )
#+END_SRC

** esh-autosuggestè‡ªåŠ¨è¡¥å…¨

[[https://github.com/dieggsy/esh-autosuggest][esh-autosuggest]] æä¾›Fishç±»ä¼¼çš„Eshellå‘½ä»¤è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚ç±»ä¼¼çš„æ’ä»¶è¿˜æœ‰ [[https://github.com/emacsmirror/capf-autosuggest][capf-autosuggest]]ã€‚

#+BEGIN_QUOTE
ä½¿ç”¨ =C-f= æ¥è¡¥å…¨æ•´å¥ï¼Œä½¿ç”¨ =M-f= æ¥è¡¥å…¨ä¸€ä¸ªè¯ã€‚
#+END_QUOTE

#+BEGIN_SRC emacs-lisp
(use-package esh-autosuggest
  :ensure t
  :hook (eshell-mode . esh-autosuggest-mode)
  )
#+END_SRC

** eshell-upå¿«é€Ÿè¿›å…¥çˆ¶çº§æ–‡ä»¶å¤¹

[[https://github.com/peterwvj/eshell-up][eshell-up]] æ’ä»¶å¯ä»¥å¿«é€Ÿè¿›å…¥å½“å‰æ–‡ä»¶å¤¹çš„ä»»ä½•ä¸€ä¸ªçˆ¶çº§æ–‡ä»¶å¤¹ã€‚é€šè¿‡ =up= å‘½ä»¤ï¼ˆå·²ç»è®¾ç½®äº†aliasï¼‰è¿›å…¥å½“å‰æ–‡ä»¶å¤¹çš„ä»»ä½•ä¸€çº§çˆ¶ç›®å½•ã€‚

#+BEGIN_SRC emacs-lisp
(use-package eshell-up
  :ensure t
  :commands (eshell-up eshell-up-peek)
  :config
  ;; to print the matching parent directory before changing to it
  (setq eshell-up-print-parent-dir t)
  )
#+END_SRC

** init-shell.el æ–‡ä»¶å°¾
#+BEGIN_SRC emacs-lisp

(provide 'init-shell)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-shell.el ends here
#+END_SRC
